<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="page-title">
                <i class="fas fa-chart-line me-2"></i>
                Thống kê & Phân tích
            </h2>
            <p class="text-muted">Tổng quan về các chỉ số và xu hướng của hệ thống</p>
        </div>
        <div class="col-auto">
            <select id="periodFilter" class="form-select me-2" style="display: inline-block; width: auto;">
                <option value="7" {{#if (eq period '7')}}selected{{/if}}>7 ngày</option>
                <option value="30" {{#if (eq period '30')}}selected{{/if}}>30 ngày</option>
                <option value="90" {{#if (eq period '90')}}selected{{/if}}>90 ngày</option>
                <option value="365" {{#if (eq period '365')}}selected{{/if}}>1 năm</option>
            </select>
            <button id="exportExcel" class="btn btn-success">
                <i class="fas fa-file-excel me-2"></i>Xuất Excel
            </button>
            <button id="exportPdf" class="btn btn-danger ms-2">
                <i class="fas fa-file-pdf me-2"></i>Xuất PDF
            </button>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Tổng yêu cầu</p>
                            <h3 class="mb-0">{{stats.totalRequests}}</h3>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>{{period}} ngày qua
                            </small>
                        </div>
                        <div class="stat-icon" style="background: rgba(0, 82, 204, 0.1); color: #0052CC; padding: 15px; border-radius: 10px;">
                            <i class="fas fa-clipboard-list fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Đã hoàn thành</p>
                            <h3 class="mb-0 text-success">{{stats.completedRequests}}</h3>
                            <small class="text-muted">
                                Tỷ lệ: {{#if stats.totalRequests}}{{math stats.completedRequests '*' 100 '/' stats.totalRequests}}%{{else}}0%{{/if}}
                            </small>
                        </div>
                        <div class="stat-icon" style="background: rgba(54, 179, 126, 0.1); color: #36B37E; padding: 15px; border-radius: 10px;">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Đang xử lý</p>
                            <h3 class="mb-0 text-warning">{{stats.inProgressRequests}}</h3>
                            <small class="text-muted">
                                Cần theo dõi
                            </small>
                        </div>
                        <div class="stat-icon" style="background: rgba(255, 153, 31, 0.1); color: #FF991F; padding: 15px; border-radius: 10px;">
                            <i class="fas fa-spinner fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Thời gian trung bình</p>
                            <h3 class="mb-0 text-info">{{stats.avgCompletionTime}}</h3>
                            <small class="text-muted">
                                Để hoàn thành
                            </small>
                        </div>
                        <div class="stat-icon" style="background: rgba(0, 184, 217, 0.1); color: #00B8D9; padding: 15px; border-radius: 10px;">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row g-3 mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        Xu hướng yêu cầu theo thời gian
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="analyticsTrendChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie text-success me-2"></i>
                        Phân bố trạng thái
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="analyticsStatusChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar text-warning me-2"></i>
                        Phân bố mức độ ưu tiên
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="analyticsPriorityChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building text-purple me-2"></i>
                        Phân bố theo phòng ban
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="analyticsDepartmentChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Performers -->
    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trophy text-warning me-2"></i>
                        Top nhân viên xuất sắc
                    </h5>
                </div>
                <div class="card-body">
                    {{#if topEmployees.length}}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nhân viên</th>
                                    <th class="text-center">Đã xử lý</th>
                                    <th class="text-center">Hoàn thành</th>
                                    <th class="text-center">Đánh giá</th>
                                    <th class="text-center">Thời gian TB</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each topEmployees}}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {{#if this.Avatar}}
                                            <img src="{{this.Avatar}}" alt="{{this.UserName}}" class="rounded-circle me-2" width="32" height="32">
                                            {{else}}
                                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                                {{substring this.UserName 0 1}}
                                            </div>
                                            {{/if}}
                                            <div>
                                                <div class="fw-bold">{{this.UserName}}</div>
                                                <small class="text-muted">{{this.Email}}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">{{this.totalHandled}}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success">{{this.completedCount}}</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="text-warning">
                                            {{#each (range this.avgRating)}}
                                            <i class="fas fa-star"></i>
                                            {{/each}}
                                            <span class="text-muted ms-1">{{this.avgRating}}</span>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="text-muted">{{this.avgResponseTime}}h</span>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                    {{else}}
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-user-slash fa-3x mb-3"></i>
                        <p>Chưa có dữ liệu nhân viên</p>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>

        <!-- Department Statistics -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie text-info me-2"></i>
                        Thống kê theo phòng ban
                    </h5>
                </div>
                <div class="card-body">
                    {{#if departmentStats.length}}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Phòng ban</th>
                                    <th class="text-center">Tổng</th>
                                    <th class="text-center">Hoàn thành</th>
                                    <th class="text-center">Tỷ lệ</th>
                                    <th class="text-center">Thời gian TB</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each departmentStats}}
                                <tr>
                                    <td>
                                        <i class="fas fa-building text-muted me-2"></i>
                                        {{this.departmentName}}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">{{this.totalRequests}}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success">{{this.completed}}</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 style="width: {{#if this.totalRequests}}{{math this.completed '*' 100 '/' this.totalRequests}}{{else}}0{{/if}}%" 
                                                 aria-valuenow="{{#if this.totalRequests}}{{math this.completed '*' 100 '/' this.totalRequests}}{{else}}0{{/if}}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                {{#if this.totalRequests}}{{math this.completed '*' 100 '/' this.totalRequests}}{{else}}0{{/if}}%
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="text-muted">{{this.avgHours}}h</span>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                    {{else}}
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-building fa-3x mb-3"></i>
                        <p>Chưa có dữ liệu phòng ban</p>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Analytics Script -->
<script src="/js/analytics.js"></script>

<style>
    .stat-icon {
        transition: all 0.3s ease;
    }
    
    .card:hover .stat-icon {
        transform: scale(1.1);
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0, 82, 204, 0.05);
    }
</style>
