<link rel="stylesheet" href="/css/modern-table.css">

<div class="content-header">
    <div>
        <h1 class="page-title">Quản lý phòng ban</h1>
        <p class="page-subtitle">Quản lý thông tin các phòng ban trong tổ chức</p>
    </div>
    <div class="content-actions">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDepartmentModal">
            <i class="fas fa-plus me-2"></i>Thêm phòng ban
        </button>
    </div>
</div>

{{#if success}}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle me-2"></i>{{success}}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{{/if}}

{{#if error}}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{error}}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{{/if}}

<!-- Modern Table Container -->
<div class="modern-table-container">
    <!-- Table Header -->
    <div class="table-header-section">
        <div class="table-title-wrapper">
            <div>
                <h2 class="table-title">
                    <i class="fas fa-building" style="color: var(--table-primary);"></i>
                    Danh sách phòng ban
                </h2>
                <p class="table-subtitle">{{departments.length}} phòng ban trong tổ chức</p>
            </div>
        </div>
        <div class="table-actions">
            <button class="btn-modern btn-modern-secondary" onclick="exportDepartments()">
                <i class="fas fa-download"></i>
                Xuất Excel
            </button>
            <button class="btn-modern btn-modern-primary" data-bs-toggle="modal" data-bs-target="#addDepartmentModal">
                <i class="fas fa-plus"></i>
                Thêm phòng ban
            </button>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="table-filter-bar">
        <div class="filter-search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="tableSearch" name="search" value="{{search}}" 
                   placeholder="Tìm theo tên phòng ban, mô tả...">
        </div>

        <select class="filter-select" id="statusFilter" name="status">
            <option value="">Tất cả trạng thái</option>
            <option value="active" {{#ifEquals status 'active'}}selected{{/ifEquals}}>Hoạt động</option>
            <option value="inactive" {{#ifEquals status 'inactive'}}selected{{/ifEquals}}>Không hoạt động</option>
        </select>

        <button class="filter-btn" onclick="applyFilters()">
            <i class="fas fa-filter"></i>
            Lọc
        </button>

        <button class="filter-btn" onclick="clearFilters()">
            <i class="fas fa-times"></i>
            Xóa bộ lọc
        </button>
    </div>

    <!-- Table -->
    {{#if departments.length}}
    <div class="table-responsive">
        <table class="modern-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="table-checkbox" id="selectAll">
                    </th>
                    <th style="width: 80px;">ID</th>
                    <th>Tên phòng ban</th>
                    <th>Mô tả</th>
                    <th style="width: 150px;">Trưởng phòng</th>
                    <th class="text-center" style="width: 120px;">Số nhân viên</th>
                    <th class="text-center" style="width: 130px;">Trạng thái</th>
                    <th style="width: 140px;">Ngày tạo</th>
                    <th class="text-center" style="width: 160px;">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {{#each departments}}
                <tr>
                    <td>
                        <input type="checkbox" class="table-checkbox" value="{{DepartmentID}}">
                    </td>
                    <td>
                        <span class="table-cell-id">#{{DepartmentID}}</span>
                    </td>
                    <td>
                        <div class="table-cell-icon">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                <i class="fas fa-building"></i>
                            </div>
                            <div>
                                <div class="table-cell-name">{{Name}}</div>
                                <div class="table-cell-secondary">{{Code}}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        {{#if Description}}
                        <div class="table-cell-secondary" style="max-width: 300px;">
                            {{substring Description 0 80}}{{#if (gt Description.length 80)}}...{{/if}}
                        </div>
                        {{else}}
                        <span class="table-cell-secondary">-</span>
                        {{/if}}
                    </td>
                    <td>
                        {{#if ManagerName}}
                        <div class="table-cell-icon">
                            <div style="width: 32px; height: 32px; background: var(--table-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                                {{substring ManagerName 0 1}}
                            </div>
                            <span class="table-cell-secondary">{{ManagerName}}</span>
                        </div>
                        {{else}}
                        <span class="table-cell-secondary">Chưa có</span>
                        {{/if}}
                    </td>
                    <td class="text-center">
                        <span class="table-status-badge status-info">
                            <i class="fas fa-users"></i>
                            {{EmployeeCount}}
                        </span>
                    </td>
                    <td class="text-center">
                        {{#if IsActive}}
                        <span class="table-status-badge status-success">
                            <i class="fas fa-check-circle"></i>
                            Hoạt động
                        </span>
                        {{else}}
                        <span class="table-status-badge status-warning">
                            <i class="fas fa-ban"></i>
                            Không hoạt động
                        </span>
                        {{/if}}
                    </td>
                    <td>
                        <span class="table-cell-secondary">{{formatDate CreatedAt}}</span>
                    </td>
                    <td>
                        <div class="table-actions-cell">
                            <button class="table-action-btn action-view" title="Xem chi tiết"
                                    onclick="viewDepartment('{{DepartmentID}}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="table-action-btn action-edit" title="Chỉnh sửa"
                                    onclick="editDepartment('{{DepartmentID}}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="table-action-btn action-delete" title="Xóa"
                                    onclick="deleteDepartment('{{DepartmentID}}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {{#if pagination}}
    <div class="table-pagination">
        <div class="pagination-info">
            <span>{{departments.length}} phòng ban</span>
            <i class="fas fa-sync-alt" onclick="location.reload()" 
               style="margin-left: 12px; cursor: pointer; color: var(--table-text-secondary);" 
               title="Làm mới"></i>
        </div>
        <div class="pagination-controls">
            <button class="pagination-btn" {{#if pagination.isFirst}}disabled{{/if}}
                    onclick="goToPage({{pagination.prevPage}})">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            {{#each pagination.pages}}
            <button class="pagination-btn {{#if active}}active{{/if}}"
                    onclick="goToPage({{page}})">
                {{page}}
            </button>
            {{/each}}
            
            <button class="pagination-btn" {{#if pagination.isLast}}disabled{{/if}}
                    onclick="goToPage({{pagination.nextPage}})">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    {{/if}}
    {{else}}
    <div class="table-empty-state">
        <div class="table-empty-icon">
            <i class="fas fa-building"></i>
        </div>
        <div class="table-empty-text">Không tìm thấy phòng ban</div>
        <div class="table-empty-subtext">
            {{#if search}}
            Không có phòng ban nào phù hợp với từ khóa "{{search}}"
            {{else}}
            Chưa có phòng ban nào trong hệ thống.
            {{/if}}
        </div>
    </div>
    {{/if}}
</div>

<!-- Add Department Modal -->
<div class="modal fade" id="addDepartmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>Thêm phòng ban mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addDepartmentForm" method="POST" action="/departments/add">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tên phòng ban *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã phòng ban *</label>
                        <input type="text" class="form-control" name="code" required placeholder="Ví dụ: IT, HR, FIN...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Trưởng phòng</label>
                        <select class="form-select" name="manager">
                            <option value="">-- Chọn trưởng phòng --</option>
                            {{#each users}}
                            <option value="{{Id}}">{{UserName}}</option>
                            {{/each}}
                        </select>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="isActive" id="isActiveAdd" checked>
                        <label class="form-check-label" for="isActiveAdd">
                            Kích hoạt phòng ban
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Thêm phòng ban
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Filter functions
function getCurrentFilters() {
    const params = new URLSearchParams();
    const search = document.getElementById('tableSearch')?.value;
    const status = document.getElementById('statusFilter')?.value;
    
    if (search) params.set('search', search);
    if (status) params.set('status', status);
    
    return params;
}

function applyFilters() {
    const params = getCurrentFilters();
    params.set('page', 1);
    window.location.search = params.toString();
}

function clearFilters() {
    window.location.href = '/departments';
}

// Search on Enter
document.getElementById('tableSearch')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') applyFilters();
});

// Auto-submit on filter change
document.getElementById('statusFilter')?.addEventListener('change', applyFilters);

// Select all checkbox
document.getElementById('selectAll')?.addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.modern-table tbody .table-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// Pagination
function goToPage(page) {
    const params = getCurrentFilters();
    params.set('page', page);
    window.location.search = params.toString();
}

// Department actions
function viewDepartment(id) {
    window.location.href = `/departments/${id}`;
}

function editDepartment(id) {
    window.location.href = `/departments/${id}/edit`;
}

function deleteDepartment(id) {
    if (confirm('Bạn có chắc chắn muốn xóa phòng ban này?')) {
        fetch(`/departments/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert('Có lỗi xảy ra!');
        });
    }
}

function exportDepartments() {
    alert('Chức năng xuất Excel đang được phát triển.');
}
</script>
