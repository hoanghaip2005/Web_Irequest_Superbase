<link rel="stylesheet" href="/css/modern-table.css">
<link rel="stylesheet" href="/css/users.css">

<div class="content-header">
    <div>
        <h1 class="page-title">
            <i class="fas fa-user me-2"></i>
            Chi tiết nhân viên
        </h1>
        <p class="page-subtitle">Thông tin đầy đủ về nhân viên</p>
    </div>
    <div class="content-actions">
        <a href="/employees" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Quay lại
        </a>
        {{#if user.isAdmin}}
        <a href="/employees/{{employee.Id}}/edit" class="btn btn-primary">
            <i class="fas fa-edit me-2"></i>Chỉnh sửa
        </a>
        {{/if}}
    </div>
</div>

{{#if success}}
<div class="alert alert-success alert-dismissible fade show">
    <i class="fas fa-check-circle me-2"></i>{{success}}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{{/if}}

<div class="row">
    <!-- Left Column: Profile Card -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-body text-center">
                <!-- Avatar -->
                <div class="mb-3">
                    {{#if employee.Avatar}}
                    <img src="{{employee.Avatar}}" alt="{{employee.UserName}}" 
                         class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover; border: 4px solid #f0f0f0;">
                    {{else}}
                    <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" 
                         style="width: 150px; height: 150px; font-size: 4rem; border: 4px solid #f0f0f0;">
                        {{substring employee.UserName 0 1}}
                    </div>
                    {{/if}}
                </div>

                <!-- User Name -->
                <h3 class="mb-1">{{employee.UserName}}</h3>
                <p class="text-muted mb-3">@{{employee.Email}}</p>

                <!-- Status Badges -->
                <div class="mb-3">
                    {{#if employee.isAdmin}}
                    <span class="badge bg-danger mb-2 me-1">
                        <i class="fas fa-user-shield me-1"></i>Quản trị viên
                    </span>
                    {{/if}}
                    
                    {{#if employee.IsActive}}
                    <span class="badge bg-success mb-2">
                        <i class="fas fa-check-circle me-1"></i>Đang hoạt động
                    </span>
                    {{else}}
                    <span class="badge bg-warning mb-2">
                        <i class="fas fa-ban me-1"></i>Tạm khóa
                    </span>
                    {{/if}}

                    {{#if employee.EmailConfirmed}}
                    <span class="badge bg-info mb-2">
                        <i class="fas fa-envelope-open-text me-1"></i>Email đã xác thực
                    </span>
                    {{/if}}
                </div>

                <hr>

                <!-- Quick Info -->
                <div class="text-start">
                    {{#if employee.DepartmentName}}
                    <div class="mb-3">
                        <label class="text-muted small">Phòng ban</label>
                        <div>
                            <i class="fas fa-building me-2 text-primary"></i>
                            <strong>{{employee.DepartmentName}}</strong>
                        </div>
                    </div>
                    {{/if}}

                    {{#if employee.Position}}
                    <div class="mb-3">
                        <label class="text-muted small">Chức vụ</label>
                        <div>
                            <i class="fas fa-id-badge me-2 text-primary"></i>
                            <strong>{{employee.Position}}</strong>
                        </div>
                    </div>
                    {{/if}}

                    {{#if employee.PhoneNumber}}
                    <div class="mb-3">
                        <label class="text-muted small">Số điện thoại</label>
                        <div>
                            <i class="fas fa-phone me-2 text-primary"></i>
                            <a href="tel:{{employee.PhoneNumber}}">{{employee.PhoneNumber}}</a>
                        </div>
                    </div>
                    {{/if}}

                    {{#if employee.HomeAdress}}
                    <div class="mb-3">
                        <label class="text-muted small">Địa chỉ</label>
                        <div>
                            <i class="fas fa-home me-2 text-primary"></i>
                            {{employee.HomeAdress}}
                        </div>
                    </div>
                    {{/if}}

                    <div class="mb-3">
                        <label class="text-muted small">Ngày tham gia</label>
                        <div>
                            <i class="fas fa-calendar me-2 text-primary"></i>
                            {{formatDate employee.CreatedAt}}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roles Card -->
        {{#if roles.length}}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-user-tag me-2"></i>Vai trò
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column gap-2">
                    {{#each roles}}
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <div>
                            <strong>{{Name}}</strong>
                            {{#if Description}}
                            <small class="d-block text-muted">{{Description}}</small>
                            {{/if}}
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
        {{/if}}
    </div>

    <!-- Right Column: Details & Statistics -->
    <div class="col-lg-8">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-clipboard-list fa-2x opacity-75"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="mb-0">{{stats.createdRequests}}</h3>
                                <div>Yêu cầu đã tạo</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-tasks fa-2x opacity-75"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="mb-0">{{stats.assignedRequests}}</h3>
                                <div>Được phân công</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="mb-0">{{stats.completedRequests}}</h3>
                                <div>Đã hoàn thành</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Requests -->
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Yêu cầu gần đây
                </h5>
                <a href="/requests?user={{employee.Id}}" class="btn btn-sm btn-outline-primary">
                    Xem tất cả
                </a>
            </div>
            <div class="card-body">
                {{#if recentRequests.length}}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tiêu đề</th>
                                <th>Trạng thái</th>
                                <th>Ngày tạo</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each recentRequests}}
                            <tr>
                                <td><span class="badge bg-secondary">#{{RequestID}}</span></td>
                                <td>{{Title}}</td>
                                <td>
                                    <span class="badge bg-{{StatusColor}}">{{StatusName}}</span>
                                </td>
                                <td>{{formatDate CreatedAt}}</td>
                                <td>
                                    <a href="/requests/{{RequestID}}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
                {{else}}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                    <p>Chưa có yêu cầu nào</p>
                </div>
                {{/if}}
            </div>
        </div>

        <!-- Activity Timeline -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-stream me-2"></i>Hoạt động gần đây
                </h5>
            </div>
            <div class="card-body">
                {{#if activities.length}}
                <div class="timeline">
                    {{#each activities}}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-{{color}}">
                            <i class="fas fa-{{icon}}"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <strong>{{type}}</strong>
                                <small class="text-muted">{{formatDate createdAt}}</small>
                            </div>
                            <div class="timeline-body">
                                {{description}}
                            </div>
                        </div>
                    </div>
                    {{/each}}
                </div>
                {{else}}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-clock fa-3x mb-3 d-block"></i>
                    <p>Chưa có hoạt động nào</p>
                </div>
                {{/if}}
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-radius: 12px;
    margin-bottom: 1.5rem;
}

.card-header {
    border-bottom: 1px solid #e5e7eb;
    padding: 1rem 1.5rem;
}

.timeline {
    position: relative;
    padding-left: 50px;
}

.timeline-item {
    position: relative;
    padding-bottom: 20px;
}

.timeline-item:not(:last-child):before {
    content: '';
    position: absolute;
    left: -33px;
    top: 30px;
    width: 2px;
    height: calc(100% - 10px);
    background: #e5e7eb;
}

.timeline-marker {
    position: absolute;
    left: -45px;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
}

.timeline-content {
    background: #f9fafb;
    padding: 12px 15px;
    border-radius: 8px;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.bg-primary { background-color: #0d6efd !important; }
.bg-success { background-color: #198754 !important; }
.bg-info { background-color: #0dcaf0 !important; }
.bg-warning { background-color: #ffc107 !important; }
.bg-danger { background-color: #dc3545 !important; }
.bg-secondary { background-color: #6c757d !important; }
</style>
