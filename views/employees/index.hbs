<link rel="stylesheet" href="/css/modern-table.css">

<div class="content-header">
    <div>
        <h1 class="page-title">Quản lý nhân viên</h1>
        <p class="page-subtitle">Quản lý thông tin nhân viên và phân quyền</p>
    </div>
    <div class="content-actions">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
            <i class="fas fa-plus me-2"></i>Thêm nhân viên
        </button>
    </div>
</div>

{{#if success}}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle me-2"></i>{{success}}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{{/if}}

{{#if error}}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{error}}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{{/if}}

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-card-body">
                <div class="stats-card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stats-card-content">
                    <h3 class="stats-card-value">{{totalUsers}}</h3>
                    <p class="stats-card-label">Tổng nhân viên</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-card-body">
                <div class="stats-card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="stats-card-content">
                    <h3 class="stats-card-value">{{activeUsers}}</h3>
                    <p class="stats-card-label">Đang hoạt động</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-card-body">
                <div class="stats-card-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stats-card-content">
                    <h3 class="stats-card-value">{{adminUsers}}</h3>
                    <p class="stats-card-label">Quản trị viên</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-card-body">
                <div class="stats-card-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <i class="fas fa-building"></i>
                </div>
                <div class="stats-card-content">
                    <h3 class="stats-card-value">{{departmentCount}}</h3>
                    <p class="stats-card-label">Phòng ban</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modern Table Container -->
<div class="modern-table-container">
    <!-- Table Header -->
    <div class="table-header-section">
        <div class="table-title-wrapper">
            <div>
                <h2 class="table-title">
                    <i class="fas fa-users" style="color: var(--table-primary);"></i>
                    Danh sách nhân viên
                </h2>
                <p class="table-subtitle">{{users.length}} nhân viên trong hệ thống</p>
            </div>
        </div>
        <div class="table-actions">
            <button class="btn-modern btn-modern-secondary" onclick="exportEmployees()">
                <i class="fas fa-download"></i>
                Xuất Excel
            </button>
            <button class="btn-modern btn-modern-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
                <i class="fas fa-plus"></i>
                Thêm nhân viên
            </button>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="table-filter-bar">
        <div class="filter-search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="tableSearch" name="search" value="{{search}}" 
                   placeholder="Tìm theo tên, email...">
        </div>

        <select class="filter-select" id="departmentFilter" name="department">
            <option value="">Tất cả phòng ban</option>
            {{#each departments}}
            <option value="{{DepartmentID}}" {{#ifEquals DepartmentID ../selectedDepartment}}selected{{/ifEquals}}>
                {{Name}}
            </option>
            {{/each}}
        </select>

        <select class="filter-select" id="roleFilter" name="role">
            <option value="">Tất cả vai trò</option>
            {{#each roles}}
            <option value="{{Id}}" {{#ifEquals Id ../selectedRole}}selected{{/ifEquals}}>
                {{Name}}
            </option>
            {{/each}}
        </select>

        <button class="filter-btn" onclick="applyFilters()">
            <i class="fas fa-filter"></i>
            Lọc
        </button>

        <button class="filter-btn" onclick="clearFilters()">
            <i class="fas fa-times"></i>
            Xóa bộ lọc
        </button>
    </div>

    <!-- Table -->
    {{#if users.length}}
    <div class="table-responsive">
        <table class="modern-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="table-checkbox" id="selectAll">
                    </th>
                    <th style="width: 250px;">Nhân viên</th>
                    <th style="width: 200px;">Email</th>
                    <th style="width: 150px;">Phòng ban</th>
                    <th style="width: 120px;">Chức vụ</th>
                    <th class="text-center" style="width: 130px;">Vai trò</th>
                    <th class="text-center" style="width: 120px;">Trạng thái</th>
                    <th style="width: 140px;">Ngày tạo</th>
                    <th class="text-center" style="width: 180px;">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {{#each users}}
                <tr>
                    <td>
                        <input type="checkbox" class="table-checkbox" value="{{Id}}">
                    </td>
                    <td>
                        <div class="table-cell-icon">
                            {{#if Avatar}}
                            <img src="{{Avatar}}" alt="{{UserName}}" 
                                 style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                            {{else}}
                            <div style="width: 40px; height: 40px; background: var(--table-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">
                                {{substring UserName 0 1}}
                            </div>
                            {{/if}}
                            <div>
                                <div class="table-cell-name">{{UserName}}</div>
                                <div class="table-cell-secondary">@{{UserName}}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-icon">
                            <i class="fas fa-envelope" style="color: var(--table-text-secondary);"></i>
                            <span class="table-cell-secondary">{{Email}}</span>
                        </div>
                    </td>
                    <td>
                        {{#if DepartmentName}}
                        <span class="table-status-badge status-info">
                            <i class="fas fa-building"></i>
                            {{DepartmentName}}
                        </span>
                        {{else}}
                        <span class="table-cell-secondary">Chưa phân</span>
                        {{/if}}
                    </td>
                    <td>
                        {{#if Position}}
                        <span class="table-cell-secondary">{{Position}}</span>
                        {{else}}
                        <span class="table-cell-secondary">-</span>
                        {{/if}}
                    </td>
                    <td class="text-center">
                        {{#if IsAdmin}}
                        <span class="table-status-badge status-danger">
                            <i class="fas fa-user-shield"></i>
                            Admin
                        </span>
                        {{else}}
                        <span class="table-status-badge status-info">
                            <i class="fas fa-user"></i>
                            User
                        </span>
                        {{/if}}
                    </td>
                    <td class="text-center">
                        {{#if IsActive}}
                        <span class="table-status-badge status-success">
                            <i class="fas fa-check-circle"></i>
                            Hoạt động
                        </span>
                        {{else}}
                        <span class="table-status-badge status-warning">
                            <i class="fas fa-ban"></i>
                            Khóa
                        </span>
                        {{/if}}
                    </td>
                    <td>
                        <span class="table-cell-secondary">{{formatDate CreatedAt}}</span>
                    </td>
                    <td>
                        <div class="table-actions-cell">
                            <button class="table-action-btn action-view" title="Xem chi tiết"
                                    onclick="viewEmployee('{{Id}}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="table-action-btn action-edit" title="Chỉnh sửa"
                                    onclick="editEmployee('{{Id}}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="table-action-btn action-delete" title="Xóa"
                                    onclick="deleteEmployee('{{Id}}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {{#if pagination}}
    <div class="table-pagination">
        <div class="pagination-info">
            <span>{{users.length}} nhân viên</span>
            <i class="fas fa-sync-alt" onclick="location.reload()" 
               style="margin-left: 12px; cursor: pointer; color: var(--table-text-secondary);" 
               title="Làm mới"></i>
        </div>
        <div class="pagination-controls">
            <button class="pagination-btn" {{#if pagination.isFirst}}disabled{{/if}}
                    onclick="goToPage({{pagination.prevPage}})">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            {{#each pagination.pages}}
            <button class="pagination-btn {{#if active}}active{{/if}}"
                    onclick="goToPage({{page}})">
                {{page}}
            </button>
            {{/each}}
            
            <button class="pagination-btn" {{#if pagination.isLast}}disabled{{/if}}
                    onclick="goToPage({{pagination.nextPage}})">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    {{/if}}
    {{else}}
    <div class="table-empty-state">
        <div class="table-empty-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="table-empty-text">Không tìm thấy nhân viên</div>
        <div class="table-empty-subtext">
            {{#if search}}
            Không có nhân viên nào phù hợp với từ khóa "{{search}}"
            {{else}}
            Chưa có nhân viên nào trong hệ thống.
            {{/if}}
        </div>
    </div>
    {{/if}}
</div>

<!-- Add Employee Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Thêm nhân viên mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addEmployeeForm" method="POST" action="/employees/add">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tên đăng nhập *</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Họ tên *</label>
                            <input type="text" class="form-control" name="fullName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Số điện thoại</label>
                            <input type="tel" class="form-control" name="phone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phòng ban</label>
                            <select class="form-select" name="department">
                                <option value="">-- Chọn phòng ban --</option>
                                {{#each departments}}
                                <option value="{{DepartmentID}}">{{Name}}</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Chức vụ</label>
                            <input type="text" class="form-control" name="position" placeholder="Ví dụ: Nhân viên, Trưởng phòng...">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mật khẩu *</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Xác nhận mật khẩu *</label>
                            <input type="password" class="form-control" name="confirmPassword" required>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="isAdmin" id="isAdmin">
                                <label class="form-check-label" for="isAdmin">
                                    Quản trị viên
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="isActive" id="isActive" checked>
                                <label class="form-check-label" for="isActive">
                                    Kích hoạt tài khoản
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Thêm nhân viên
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.stats-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
}

.stats-card-body {
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.stats-card-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
}

.stats-card-content {
    flex: 1;
}

.stats-card-value {
    font-size: 28px;
    font-weight: 700;
    margin: 0;
    color: #1f2937;
}

.stats-card-label {
    font-size: 14px;
    color: #6b7280;
    margin: 0;
}
</style>

<script>
// Filter functions
function getCurrentFilters() {
    const params = new URLSearchParams();
    const search = document.getElementById('tableSearch')?.value;
    const department = document.getElementById('departmentFilter')?.value;
    const role = document.getElementById('roleFilter')?.value;
    
    if (search) params.set('search', search);
    if (department) params.set('department', department);
    if (role) params.set('role', role);
    
    return params;
}

function applyFilters() {
    const params = getCurrentFilters();
    params.set('page', 1);
    window.location.search = params.toString();
}

function clearFilters() {
    window.location.href = '/employees';
}

// Search on Enter
document.getElementById('tableSearch')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') applyFilters();
});

// Auto-submit on filter change
document.getElementById('departmentFilter')?.addEventListener('change', applyFilters);
document.getElementById('roleFilter')?.addEventListener('change', applyFilters);

// Select all checkbox
document.getElementById('selectAll')?.addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.modern-table tbody .table-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// Pagination
function goToPage(page) {
    const params = getCurrentFilters();
    params.set('page', page);
    window.location.search = params.toString();
}

// Employee actions
function viewEmployee(id) {
    window.location.href = `/employees/${id}`;
}

function editEmployee(id) {
    window.location.href = `/employees/${id}/edit`;
}

function deleteEmployee(id) {
    if (confirm('Bạn có chắc chắn muốn xóa nhân viên này?')) {
        fetch(`/employees/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert('Có lỗi xảy ra!');
        });
    }
}

function exportEmployees() {
    alert('Chức năng xuất Excel đang được phát triển.');
}
</script>
