<link rel="stylesheet" href="/css/dashboard.css">

<div class="dashboard-wrapper">


    <!-- Tab Navigation -->
    <div class="dashboard-tabs">
        <button class="dashboard-tab active" data-tab="all">
            Toàn hệ thống
            {{#if stats.totalRequests}}
            <span class="tab-badge">{{stats.totalRequests}}</span>
            {{/if}}
        </button>
        <button class="dashboard-tab" data-tab="my">
            Yêu cầu của tôi
            {{#if stats.myRequests}}
            <span class="tab-badge">{{stats.myRequests}}</span>
            {{/if}}
        </button>
        <button class="dashboard-tab" data-tab="assigned">
            Được giao
            {{#if stats.assignedToMe}}
            <span class="tab-badge">{{stats.assignedToMe}}</span>
            {{/if}}
        </button>
        <button class="dashboard-tab" data-tab="inProgress">
            Đang xử lý
            {{#if stats.inProgress}}
            <span class="tab-badge">{{stats.inProgress}}</span>
            {{/if}}
        </button>
    </div>

    <div class="dashboard-container">
        <!-- Dashboard Header with Filters -->
        <div class="dashboard-header-section">
            <div class="header-title-wrapper">
                <h1 class="dashboard-title">Dashboard</h1>
            </div>
            
            <div class="header-filters">
                <!-- Time Range Buttons -->
                <div class="filter-group">
                    <button class="filter-btn" data-days="1">Hôm qua</button>
                    <button class="filter-btn filter-btn-active" data-days="7">7 ngày trước</button>
                    <button class="filter-btn" data-days="30">30 ngày trước</button>
                </div>
                
                <!-- Date Range Picker -->
                <div class="filter-group">
                    <div class="date-range-picker">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="date" id="startDate" class="date-input" style="width: 120px;">
                        <span>-</span>
                        <input type="date" id="endDate" class="date-input" style="width: 120px;">
                    </div>
                </div>
                
                <!-- Department Filter -->
                <div class="filter-group">
                    <select class="filter-select" id="departmentFilter">
                        <option value="">Tất cả phòng ban</option>
                        {{#each departments}}
                        <option value="{{this.DepartmentID}}">{{this.Name}}</option>
                        {{/each}}
                    </select>
                </div>
                
                <!-- Priority Filter -->
                <div class="filter-group">
                    <select class="filter-select" id="priorityFilter">
                        <option value="">Tất cả mức độ</option>
                        {{#each priorities}}
                        <option value="{{this.PriorityID}}">{{this.PriorityName}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <!-- Total Requests Card -->
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon-wrapper icon-primary">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        12%
                    </div>
                </div>
                <div class="stat-label">Tổng số yêu cầu</div>
                <div class="stat-value">{{stats.myRequests}}</div>
                <div class="stat-description">
                    <a href="/requests/my" class="stat-link">
                        <i class="fas fa-arrow-right"></i> Xem chi tiết
                    </a>
                </div>
            </div>

            <!-- Assigned Requests Card -->
            <div class="stat-card stat-success">
                <div class="stat-header">
                    <div class="stat-icon-wrapper icon-success">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        8%
                    </div>
                </div>
                <div class="stat-label">Được giao cho tôi</div>
                <div class="stat-value">{{stats.assignedToMe}}</div>
                <div class="stat-description">
                    <a href="/requests/assigned" class="stat-link">
                        <i class="fas fa-arrow-right"></i> Xem chi tiết
                    </a>
                </div>
            </div>

            <!-- Pending Requests Card -->
            <div class="stat-card stat-warning">
                <div class="stat-header">
                    <div class="stat-icon-wrapper icon-warning">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="stat-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        5%
                    </div>
                </div>
                <div class="stat-label">Đang chờ xử lý</div>
                <div class="stat-value">{{stats.pendingRequests}}</div>
                <div class="stat-description">
                    <span class="stat-users">
                        <i class="fas fa-circle text-warning" style="font-size: 8px;"></i>
                        <span class="user-count-badge">Cần xử lý</span>
                    </span>
                </div>
            </div>

            <!-- Completed Requests Card -->
            <div class="stat-card stat-info">
                <div class="stat-header">
                    <div class="stat-icon-wrapper icon-info">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-trend trend-down">
                        <i class="fas fa-arrow-down"></i>
                        2%
                    </div>
                </div>
                <div class="stat-label">Hoàn thành</div>
                <div class="stat-value">{{stats.completedRequests}}</div>
                <div class="stat-description">
                    <span class="stat-users">
                        <i class="fas fa-circle text-success" style="font-size: 8px;"></i>
                        <span class="user-count-badge">Tuần này</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Charts Layout -->
        <div class="charts-layout">
            <!-- Request Trend Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-chart-bar"></i>
                        Xu hướng yêu cầu theo tuần
                    </h3>
                    <div class="chart-actions">
                        <button class="chart-filter active">Tuần</button>
                        <button class="chart-filter">Tháng</button>
                        <button class="chart-filter">Năm</button>
                    </div>
                </div>
                
                <div class="chart-body">
                    <canvas id="trendChart" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00B8D4;"></div>
                        <span>Mới tạo</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4CAF50;"></div>
                        <span>Hoàn thành</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B;"></div>
                        <span>Đã hủy</span>
                    </div>
                </div>
            </div>

            <!-- Status Distribution Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-chart-pie"></i>
                        Phân bố trạng thái
                    </h3>
                </div>
                
                <div class="chart-body">
                    <canvas id="statusChart" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FFA726;"></div>
                        <span>Mới</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00B8D4;"></div>
                        <span>Đang xử lý</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4CAF50;"></div>
                        <span>Hoàn thành</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #E91E63;"></div>
                        <span>Đã hủy</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Priority Chart - Full Width -->
        <div class="charts-layout">
            <div class="chart-card chart-full-width">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-chart-area"></i>
                        Phân bố theo mức độ ưu tiên
                    </h3>
                    <div class="chart-actions">
                        <button class="chart-filter">Ngày</button>
                        <button class="chart-filter active">Tuần</button>
                        <button class="chart-filter">Tháng</button>
                    </div>
                </div>
                
                <div class="chart-body">
                    <canvas id="priorityChart" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #DC3545;"></div>
                        <span>Khẩn cấp</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FFA726;"></div>
                        <span>Cao</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FFD700;"></div>
                        <span>Trung bình</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4CAF50;"></div>
                        <span>Thấp</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Layout with Sidebar -->
        <div class="content-layout">
            <!-- Main Content - Activity Feed -->
            <div class="activity-card">
                <div class="activity-header">
                    <h3 class="activity-title">Hoạt động gần đây</h3>
                    <a href="/requests/my" class="activity-link">Xem thêm</a>
                </div>
                
                <div class="activity-list">
                    {{#if recentRequests.length}}
                        {{#each recentRequests}}
                        <a href="/requests/{{this.RequestID}}" class="activity-item">
                            <div class="activity-avatar">{{substring this.CreatedByName 0 1}}</div>
                            <div class="activity-content">
                                <div class="activity-text">
                                    <strong>{{this.CreatedByName}}</strong> {{#if (eq this.relationType 'created')}}đã tạo{{else}}đã cập nhật{{/if}} yêu cầu 
                                    <strong>{{this.Title}}</strong>
                                </div>
                                <div class="activity-time">{{formatDateTime this.UpdatedAt}}</div>
                            </div>
                        </a>
                        {{/each}}
                    {{else}}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>Chưa có hoạt động nào</p>
                        </div>
                    {{/if}}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar-section">
                <!-- Assigned Tasks Card -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">
                            <i class="fas fa-tasks"></i>
                            Công việc được giao
                        </h3>
                        <a href="/requests/assigned" class="activity-link">Xem tất cả</a>
                    </div>
                    
                    <div class="status-list">
                        {{#if upcomingTasks.length}}
                            {{#each upcomingTasks}}
                            <a href="/requests/{{this.RequestID}}" class="status-item task-item-link">
                                <div class="status-label-wrapper">
                                    {{#if (eq this.PriorityName 'Cao')}}
                                        <div class="status-indicator status-warning"></div>
                                    {{else if (eq this.PriorityName 'Khẩn cấp')}}
                                        <div class="status-indicator status-offline"></div>
                                    {{else}}
                                        <div class="status-indicator status-online"></div>
                                    {{/if}}
                                    <div>
                                        <div class="status-name">{{this.Title}}</div>
                                        <div class="status-meta">
                                            <i class="fas fa-user"></i>
                                            {{this.CreatedByName}}
                                        </div>
                                    </div>
                                </div>
                                <div class="status-value">#{{this.RequestID}}</div>
                            </a>
                            {{/each}}
                        {{else}}
                            <div class="empty-state-small">
                                <i class="fas fa-check-circle text-success"></i>
                                <p>Không có công việc đang chờ</p>
                            </div>
                        {{/if}}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">
                            <i class="fas fa-bolt"></i>
                            Thao tác nhanh
                        </h3>
                    </div>
                    
                    <div class="quick-actions-list">
                        <a href="/requests/create" class="quick-action-item">
                            <div class="quick-action-icon bg-primary">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <div class="quick-action-content">
                                <div class="quick-action-title">Tạo yêu cầu mới</div>
                                <div class="quick-action-desc">Gửi yêu cầu hỗ trợ</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        
                        <a href="/requests/my?view=kanban" class="quick-action-item">
                            <div class="quick-action-icon bg-purple">
                                <i class="fas fa-columns"></i>
                            </div>
                            <div class="quick-action-content">
                                <div class="quick-action-title">Kanban Board</div>
                                <div class="quick-action-desc">Xem bảng công việc</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        
                        <a href="/calendar" class="quick-action-item">
                            <div class="quick-action-icon bg-orange">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="quick-action-content">
                                <div class="quick-action-title">Lịch & Sự kiện</div>
                                <div class="quick-action-desc">Quản lý thời gian</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        
                        <a href="/reports" class="quick-action-item">
                            <div class="quick-action-icon bg-success">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="quick-action-content">
                                <div class="quick-action-title">Báo cáo</div>
                                <div class="quick-action-desc">Thống kê chi tiết</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>

                <!-- System Info -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">
                            <i class="fas fa-info-circle"></i>
                            Thông tin hệ thống
                        </h3>
                    </div>
                    
                    <div class="status-list">
                        <div class="status-item">
                            <div class="status-label-wrapper">
                                <div class="status-indicator status-online"></div>
                                <span class="status-name">Hệ thống hoạt động</span>
                            </div>
                            <div class="status-value">
                                <span class="status-percentage">Online</span>
                            </div>
                        </div>
                        
                        <div class="status-item">
                            <div class="status-label-wrapper">
                                <i class="fas fa-bell" style="color: var(--text-muted); font-size: 14px;"></i>
                                <span class="status-name">Thông báo chưa đọc</span>
                            </div>
                            <div class="status-value">{{unreadNotifications}}</div>
                        </div>
                        
                        <div class="status-item">
                            <div class="status-label-wrapper">
                                <i class="fas fa-clipboard-list" style="color: var(--text-muted); font-size: 14px;"></i>
                                <span class="status-name">Tổng yêu cầu</span>
                            </div>
                            <div class="status-value">{{stats.myRequests}}</div>
                        </div>

                        <div class="status-item">
                            <div class="status-label-wrapper">
                                <i class="fas fa-hourglass-half" style="color: var(--text-muted); font-size: 14px;"></i>
                                <span class="status-name">Đang chờ xử lý</span>
                            </div>
                            <div class="status-value">{{stats.pendingRequests}}</div>
                        </div>

                        <div class="status-item">
                            <div class="status-label-wrapper">
                                <i class="fas fa-check-circle" style="color: var(--text-muted); font-size: 14px;"></i>
                                <span class="status-name">Hoàn thành tuần này</span>
                            </div>
                            <div class="status-value">{{stats.completedRequests}}</div>
                        </div>

                        <div class="status-item">
                            <div class="status-label-wrapper">
                                <i class="fas fa-user-check" style="color: var(--text-muted); font-size: 14px;"></i>
                                <span class="status-name">Được giao cho tôi</span>
                            </div>
                            <div class="status-value">{{stats.assignedToMe}}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Global variables
    let trendChart, statusChart, priorityChart;
    let currentFilters = {
        days: 7,
        tab: 'all',
        departmentId: '',
        priorityId: '',
        startDate: '',
        endDate: ''
    };

    // Initialize charts
    function initCharts() {
        const trendCtx = document.getElementById('trendChart');
        if (trendCtx) {
            trendChart = new Chart(trendCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Mới tạo',
                            data: [],
                            backgroundColor: '#00B8D4',
                            borderRadius: 6,
                            barThickness: 20
                        },
                        {
                            label: 'Hoàn thành',
                            data: [],
                            backgroundColor: '#4CAF50',
                            borderRadius: 6,
                            barThickness: 20
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#E8ECEF'
                            }
                        }
                    }
                }
            });
        }

        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#FFA726', '#00B8D4', '#4CAF50', '#E91E63', '#9C27B0'],
                        borderWidth: 0,
                        cutout: '70%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        const priorityCtx = document.getElementById('priorityChart');
        if (priorityCtx) {
            priorityChart = new Chart(priorityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#E8ECEF'
                            }
                        }
                    }
                }
            });
        }
    }

    // Load chart data from API
    async function loadChartData() {
        try {
            const params = new URLSearchParams({
                days: currentFilters.days,
                tab: currentFilters.tab
            });

            if (currentFilters.departmentId) {
                params.append('departmentId', currentFilters.departmentId);
            }
            if (currentFilters.priorityId) {
                params.append('priorityId', currentFilters.priorityId);
            }

            const response = await fetch(`/api/dashboard/chart-data?${params.toString()}`);
            const data = await response.json();

            // Update Trend Chart
            if (trendChart && data.trend) {
                const labels = data.trend.map(item => {
                    const date = new Date(item.date);
                    return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
                });
                const createdData = data.trend.map(item => parseInt(item.created) || 0);
                const completedData = data.trend.map(item => parseInt(item.completed) || 0);

                trendChart.data.labels = labels;
                trendChart.data.datasets[0].data = createdData;
                trendChart.data.datasets[1].data = completedData;
                trendChart.update();
            }

            // Update Status Chart
            if (statusChart && data.status) {
                const labels = data.status.map(item => item.status);
                const counts = data.status.map(item => parseInt(item.count) || 0);

                statusChart.data.labels = labels;
                statusChart.data.datasets[0].data = counts;
                statusChart.update();
            }

            // Update Priority Chart
            if (priorityChart && data.priority) {
                const labels = data.priority.map(item => item.priority);
                const counts = data.priority.map(item => parseInt(item.count) || 0);
                
                const colors = {
                    'Cao': '#DC3545',
                    'Trung bình': '#FFA726',
                    'Thấp': '#4CAF50'
                };

                priorityChart.data.labels = labels;
                priorityChart.data.datasets = labels.map((label, index) => ({
                    label: label,
                    data: [counts[index]],
                    borderColor: colors[label] || '#9C27B0',
                    backgroundColor: `${colors[label] || '#9C27B0'}20`,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: colors[label] || '#9C27B0'
                }));
                priorityChart.update();
            }

        } catch (error) {
            console.error('Error loading chart data:', error);
        }
    }

    // Initialize
    initCharts();
    loadChartData();

    // Tab switching
    const tabs = document.querySelectorAll('.dashboard-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            currentFilters.tab = this.getAttribute('data-tab');
            loadChartData();
        });
    });

    // Time range filter buttons
    const filterBtns = document.querySelectorAll('.filter-btn[data-days]');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const group = this.parentElement;
            group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('filter-btn-active'));
            this.classList.add('filter-btn-active');
            currentFilters.days = parseInt(this.getAttribute('data-days'));
            loadChartData();
        });
    });

    // Department filter
    const departmentFilter = document.getElementById('departmentFilter');
    if (departmentFilter) {
        departmentFilter.addEventListener('change', function() {
            currentFilters.departmentId = this.value;
            loadChartData();
        });
    }

    // Priority filter
    const priorityFilter = document.getElementById('priorityFilter');
    if (priorityFilter) {
        priorityFilter.addEventListener('change', function() {
            currentFilters.priorityId = this.value;
            loadChartData();
        });
    }

    // Date range picker
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    if (startDate && endDate) {
        startDate.addEventListener('change', function() {
            currentFilters.startDate = this.value;
            if (currentFilters.endDate) {
                const start = new Date(currentFilters.startDate);
                const end = new Date(currentFilters.endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                currentFilters.days = diffDays;
                loadChartData();
            }
        });

        endDate.addEventListener('change', function() {
            currentFilters.endDate = this.value;
            if (currentFilters.startDate) {
                const start = new Date(currentFilters.startDate);
                const end = new Date(currentFilters.endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                currentFilters.days = diffDays;
                loadChartData();
            }
        });
    }

    // Chart filter switching (Week/Month/Year buttons on charts)
    const chartFilters = document.querySelectorAll('.chart-filter');
    chartFilters.forEach(filter => {
        filter.addEventListener('click', function() {
            const parent = this.closest('.chart-actions');
            parent.querySelectorAll('.chart-filter').forEach(f => f.classList.remove('active'));
            this.classList.add('active');
            
            const filterText = this.textContent.trim();
            if (filterText === 'Tuần') {
                currentFilters.days = 7;
            } else if (filterText === 'Tháng') {
                currentFilters.days = 30;
            } else if (filterText === 'Năm') {
                currentFilters.days = 365;
            }
            loadChartData();
        });
    });

    // Alert close
    const alertCloses = document.querySelectorAll('.alert-close');
    alertCloses.forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.alert-message').style.display = 'none';
        });
    });
});
</script>
