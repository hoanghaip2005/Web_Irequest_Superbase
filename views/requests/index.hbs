<link rel="stylesheet" href="/css/modern-table.css">

<!-- Modern Table Container -->
<div class="modern-table-container">
    <!-- Table Header Section -->
    <div class="table-header-section">
        <div class="table-title-wrapper">
            <div>
                <h2 class="table-title">
                    <i class="fas fa-clipboard-list" style="color: var(--table-primary);"></i>
                    Tất cả yêu cầu
                </h2>
                <p class="table-subtitle">Quản lý và theo dõi tất cả yêu cầu trong hệ thống</p>
            </div>
        </div>
        <div class="table-actions">
            <button class="btn-modern btn-modern-secondary" onclick="exportToExcel('all', getCurrentFilters())">
                <i class="fas fa-file-excel"></i>
                Xuất Excel
            </button>
            <button class="btn-modern btn-modern-secondary" onclick="exportToPDF('all', getCurrentFilters())">
                <i class="fas fa-file-pdf"></i>
                Xuất PDF
            </button>
            <button class="btn-modern btn-modern-secondary" onclick="printRequests()">
                <i class="fas fa-print"></i>
                In
            </button>
            <button class="btn-modern btn-modern-primary" onclick="window.location.href='/requests/create'">
                <i class="fas fa-plus"></i>
                Tạo yêu cầu mới
            </button>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="table-filter-bar">
        <div class="filter-search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="tableSearch" name="search" value="{{filters.search}}" 
                   placeholder="Tìm kiếm theo tiêu đề, mô tả...">
        </div>

        <select class="filter-select" id="statusFilter" name="status">
            <option value="">Tất cả trạng thái</option>
            {{#each statuses}}
            <option value="{{StatusID}}" {{#ifEquals StatusID ../filters.status}}selected{{/ifEquals}}>
                {{StatusName}}
            </option>
            {{/each}}
        </select>

        <select class="filter-select" id="priorityFilter" name="priority">
            <option value="">Tất cả độ ưu tiên</option>
            {{#each priorities}}
            <option value="{{PriorityID}}" {{#ifEquals PriorityID ../filters.priority}}selected{{/ifEquals}}>
                {{PriorityName}}
            </option>
            {{/each}}
        </select>

        <button class="filter-btn" onclick="applyFilters()">
            <i class="fas fa-filter"></i>
            Lọc
        </button>

        <button class="filter-btn" onclick="clearFilters()">
            <i class="fas fa-times"></i>
            Xóa bộ lọc
        </button>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="modern-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="table-checkbox" id="selectAll">
                    </th>
                    <th style="width: 80px;">ID</th>
                    <th class="sortable" data-sort="title">Tiêu đề</th>
                    <th style="width: 150px;">Người tạo</th>
                    <th class="sortable text-center" style="width: 130px;" data-sort="status">Trạng thái</th>
                    <th class="sortable text-center" style="width: 130px;" data-sort="priority">Độ ưu tiên</th>
                    <th class="sortable" style="width: 150px;" data-sort="date">Ngày tạo</th>
                    <th class="text-center" style="width: 160px;">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {{#if requests.length}}
                {{#each requests}}
                <tr>
                    <td>
                        <input type="checkbox" class="table-checkbox" value="{{RequestID}}">
                    </td>
                    <td>
                        <span class="table-cell-id">#{{RequestID}}</span>
                    </td>
                    <td>
                        <div style="max-width: 400px;">
                            <div class="table-cell-name">
                                {{#if AttachmentURL}}
                                <i class="fas fa-paperclip" style="color: var(--table-text-secondary); margin-right: 6px;"></i>
                                {{/if}}
                                {{Title}}
                            </div>
                            {{#if Description}}
                            <div class="table-cell-secondary" style="margin-top: 4px;">
                                {{substring Description 0 80}}{{#if Description}}...{{/if}}
                            </div>
                            {{/if}}
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-icon">
                            <div style="width: 32px; height: 32px; background: var(--table-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                                {{substring CreatedByUser 0 1}}
                            </div>
                            <span class="table-cell-secondary">{{CreatedByUser}}</span>
                        </div>
                    </td>
                    <td class="text-center">
                        {{#if IsStatusFinal}}
                        <span class="table-status-badge status-success">
                            <i class="fas fa-circle"></i>
                            {{StatusName}}
                        </span>
                        {{else}}
                        <span class="table-status-badge status-warning">
                            <i class="fas fa-circle"></i>
                            {{StatusName}}
                        </span>
                        {{/if}}
                    </td>
                    <td class="text-center">
                        {{#ifEquals PriorityName "Cao"}}
                        <span class="table-status-badge status-danger">
                            <i class="fas fa-circle"></i>
                            {{PriorityName}}
                        </span>
                        {{else}}{{#ifEquals PriorityName "Trung bình"}}
                        <span class="table-status-badge status-warning">
                            <i class="fas fa-circle"></i>
                            {{PriorityName}}
                        </span>
                        {{else}}
                        <span class="table-status-badge status-info">
                            <i class="fas fa-circle"></i>
                            {{PriorityName}}
                        </span>
                        {{/ifEquals}}{{/ifEquals}}
                    </td>
                    <td>
                        <span class="table-cell-secondary">{{formatDate CreatedAt}}</span>
                    </td>
                    <td>
                        <div class="table-actions-cell">
                            <button class="table-action-btn action-view" title="Xem chi tiết" 
                                    onclick="window.location.href='/requests/{{RequestID}}'">
                                <i class="fas fa-eye"></i>
                            </button>
                            {{#ifEquals ../user.Id UsersId}}
                            <button class="table-action-btn action-edit" title="Chỉnh sửa"
                                    onclick="window.location.href='/requests/{{RequestID}}/edit'">
                                <i class="fas fa-pen"></i>
                            </button>
                            {{/ifEquals}}
                            <button class="table-action-btn action-print" title="In"
                                    onclick="window.print()">
                                <i class="fas fa-print"></i>
                            </button>
                            {{#if ../user.isAdmin}}
                            <button class="table-action-btn action-delete" title="Xóa"
                                    onclick="confirmDelete({{RequestID}})">
                                <i class="fas fa-trash"></i>
                            </button>
                            {{/if}}
                        </div>
                    </td>
                </tr>
                {{/each}}
                {{else}}
                <tr>
                    <td colspan="8">
                        <div class="table-empty-state">
                            <div class="table-empty-icon">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <div class="table-empty-text">Không có yêu cầu nào</div>
                            <div class="table-empty-subtext">
                                {{#if filters.search}}
                                Không tìm thấy yêu cầu phù hợp với từ khóa "{{filters.search}}"
                                {{else}}
                                Chưa có yêu cầu nào trong hệ thống. Nhấn "Tạo yêu cầu mới" để bắt đầu.
                                {{/if}}
                            </div>
                        </div>
                    </td>
                </tr>
                {{/if}}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {{#if pagination.total}}
    <div class="table-pagination">
        <div class="pagination-info">
            <span>{{#if pagination.totalRecords}}{{pagination.totalRecords}}{{else}}0{{/if}} kết quả</span>
            <i class="fas fa-sync-alt" onclick="location.reload()" 
               style="margin-left: 12px; cursor: pointer; color: var(--table-text-secondary);" 
               title="Làm mới"></i>
        </div>
        <div class="pagination-controls">
            <button class="pagination-btn" {{#ifEquals pagination.current 1}}disabled{{/ifEquals}}
                    onclick="goToPage({{#subtract pagination.current 1}}{{/subtract}})">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            {{#each pagination.pages}}
            <button class="pagination-btn {{#ifEquals this ../pagination.current}}active{{/ifEquals}}"
                    onclick="goToPage({{this}})">
                {{this}}
            </button>
            {{/each}}
            
            <button class="pagination-btn" {{#ifEquals pagination.current pagination.total}}disabled{{/ifEquals}}
                    onclick="goToPage({{#add pagination.current 1}}{{/add}})">
                <i class="fas fa-chevron-right"></i>
            </button>
            
            <select class="pagination-select" id="itemsPerPage" onchange="changePageSize(this.value)">
                <option value="10" {{#ifEquals pagination.limit 10}}selected{{/ifEquals}}>10 hàng/trang</option>
                <option value="20" {{#ifEquals pagination.limit 20}}selected{{/ifEquals}}>20 hàng/trang</option>
                <option value="50" {{#ifEquals pagination.limit 50}}selected{{/ifEquals}}>50 hàng/trang</option>
                <option value="100" {{#ifEquals pagination.limit 100}}selected{{/ifEquals}}>100 hàng/trang</option>
            </select>
        </div>
    </div>
    {{/if}}
</div>

<script>
// Build current URL with filters
function getCurrentFilters() {
    const params = new URLSearchParams();
    const search = document.getElementById('tableSearch')?.value;
    const status = document.getElementById('statusFilter')?.value;
    const priority = document.getElementById('priorityFilter')?.value;
    
    if (search) params.set('search', search);
    if (status) params.set('status', status);
    if (priority) params.set('priority', priority);
    
    return params;
}

// Apply filters
function applyFilters() {
    const params = getCurrentFilters();
    params.set('page', 1); // Reset to page 1
    window.location.search = params.toString();
}

// Clear filters
function clearFilters() {
    window.location.href = '/requests';
}

// Search on Enter key
document.getElementById('tableSearch')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        applyFilters();
    }
});

// Auto-submit on filter change
document.getElementById('statusFilter')?.addEventListener('change', applyFilters);
document.getElementById('priorityFilter')?.addEventListener('change', applyFilters);

// Select all checkbox
document.getElementById('selectAll')?.addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.modern-table tbody .table-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// Sorting
document.querySelectorAll('.sortable').forEach(th => {
    th.addEventListener('click', function() {
        const sortKey = this.getAttribute('data-sort');
        const tbody = this.closest('table').querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Check if already has data
        if (rows.length === 0 || rows[0].cells.length === 1) return;
        
        const isAsc = this.classList.contains('sorted-asc');
        document.querySelectorAll('.sortable').forEach(t => {
            t.classList.remove('sorted-asc', 'sorted-desc');
        });
        this.classList.add(isAsc ? 'sorted-desc' : 'sorted-asc');
        
        const colIndex = Array.from(this.parentElement.children).indexOf(this);
        rows.sort((a, b) => {
            const aText = a.cells[colIndex]?.textContent.trim() || '';
            const bText = b.cells[colIndex]?.textContent.trim() || '';
            return isAsc ? bText.localeCompare(aText) : aText.localeCompare(bText);
        });
        
        rows.forEach(row => tbody.appendChild(row));
    });
});

// Pagination functions
function goToPage(page) {
    const params = getCurrentFilters();
    params.set('page', page);
    window.location.search = params.toString();
}

function changePageSize(size) {
    const params = getCurrentFilters();
    params.set('limit', size);
    params.set('page', 1);
    window.location.search = params.toString();
}

// Delete confirmation
function confirmDelete(id) {
    if (confirm('Bạn có chắc chắn muốn xóa yêu cầu này?\n\nHành động này không thể hoàn tác.')) {
        fetch(`/requests/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Có lỗi xảy ra khi xóa yêu cầu. Vui lòng thử lại.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi xóa yêu cầu.');
        });
    }
}
</script>

<script src="/js/export.js"></script>