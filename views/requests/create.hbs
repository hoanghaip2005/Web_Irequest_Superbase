<div class='content-header'>
  <div>
    <h1 class='page-title'>Tạo yêu cầu mới</h1>
    <p class='page-subtitle'>Tạo một yêu cầu mới để báo cáo sự cố hoặc yêu cầu
      hỗ trợ</p>
  </div>
</div>

<div class='row'>
  <div class='col-xl-8 col-lg-10 mx-auto'>
    <form
      id='createRequestForm'
      action='/requests/create'
      method='POST'
      enctype='multipart/form-data'
    >
      <div class='card'>
        <div class='card-header'>
          <h5 class='card-title mb-0'>
            <i class='fas fa-edit me-2'></i>Thông tin yêu cầu
          </h5>
        </div>
        <div class='card-body'>
          <!-- Title -->
          <div class='mb-4'>
            <label for='title' class='form-label required'>Tiêu đề yêu cầu</label>
            <input
              type='text'
              class='form-control'
              id='title'
              name='title'
              required
              placeholder='Nhập tiêu đề mô tả ngắn gọn về yêu cầu...'
              maxlength='100'
            />
            <div class='form-text'>Tiêu đề ngắn gọn, rõ ràng (3-100 ký tự)</div>
          </div>

          <!-- Description -->
          <div class='mb-4'>
            <label for='description' class='form-label required'>Mô tả chi tiết</label>
            <textarea
              class='form-control'
              id='description'
              name='description'
              rows='6'
              required
              placeholder='Mô tả chi tiết về vấn đề hoặc yêu cầu của bạn...'
            ></textarea>
            <div class='form-text'>Mô tả chi tiết giúp chúng tôi hiểu và xử lý
              yêu cầu nhanh hơn (tối thiểu 10 ký tự)</div>
          </div>

          <div class='row'>
            <!-- Priority -->
            <div class='col-md-6 mb-4'>
              <label for='priorityId' class='form-label'>Độ ưu tiên</label>
              <select class='form-select' id='priorityId' name='priorityId'>
                <option value=''>Chọn độ ưu tiên</option>
                {{#each priorities}}
                  <option
                    value='{{PriorityID}}'
                    data-color='{{ColorCode}}'
                    title='{{Description}}'
                  >
                    {{PriorityName}}
                  </option>
                {{/each}}
              </select>
              <div class='form-text'>Chọn mức độ ưu tiên phù hợp với yêu cầu</div>
            </div>

            <!-- Workflow -->
            <div class='col-md-6 mb-4'>
              <label for='workflowId' class='form-label'>Quy trình xử lý</label>
              <select class='form-select' id='workflowId' name='workflowId'>
                <option value=''>Để hệ thống tự chọn</option>
                {{#each workflows}}
                  <option value='{{WorkflowID}}' title='{{Description}}'>
                    {{WorkflowName}}
                  </option>
                {{/each}}
              </select>
              <div class='form-text'>Chọn quy trình xử lý phù hợp (tùy chọn)</div>
            </div>
          </div>

          <!-- Dynamic Form Fields Container -->
          <div id='dynamicFormFields' class='mb-4' style='display: none;'>
            <hr class='my-4' />
            <h6 class='mb-3'>
              <i class='fas fa-list-ul me-2'></i>Thông tin chi tiết theo quy trình
            </h6>
            <div id='formFieldsContainer'></div>
          </div>

          <!-- Issue Type -->
          <div class='mb-4'>
            <label for='issueType' class='form-label'>Loại vấn đề</label>
            <select class='form-select' id='issueType' name='issueType'>
              <option value=''>Chọn loại vấn đề</option>
              <option value='bug'>Báo lỗi hệ thống</option>
              <option value='feature_request'>Yêu cầu tính năng mới</option>
              <option value='support'>Yêu cầu hỗ trợ</option>
              <option value='maintenance'>Bảo trì/Nâng cấp</option>
              <option value='access_request'>Yêu cầu quyền truy cập</option>
              <option value='other'>Khác</option>
            </select>
            <div class='form-text'>Phân loại giúp định tuyến yêu cầu đến đúng bộ
              phận</div>
          </div>

          <!-- File Upload -->
          <div class='mb-4'>
            <label for='attachment' class='form-label'>Đính kèm file</label>
            <input
              type='file'
              class='form-control'
              id='attachment'
              name='attachment'
              accept='.jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.txt'
            />
            <div class='form-text'>
              <i class='fas fa-info-circle me-1'></i>
              Hỗ trợ: JPG, PNG, PDF, DOC, DOCX, XLS, XLSX, TXT. Tối đa 10MB.
            </div>
            <div id='filePreview' class='mt-2' style='display: none;'>
              <div class='alert alert-info'>
                <i class='fas fa-file me-2'></i>
                <span id='fileName'></span>
                <span id='fileSize' class='text-muted'></span>
                <button
                  type='button'
                  class='btn btn-sm btn-outline-danger ms-2'
                  onclick='removeFile()'
                >
                  <i class='fas fa-times'></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class='card-footer bg-light'>
          <div class='d-flex justify-content-between'>
            <a href='/requests' class='btn btn-outline-secondary'>
              <i class='fas fa-arrow-left me-2'></i>Quay lại
            </a>
            <div>
              <button
                type='button'
                class='btn btn-outline-primary me-2'
                onclick='saveDraft()'
              >
                <i class='fas fa-save me-2'></i>Lưu nháp
              </button>
              <button type='submit' class='btn btn-primary'>
                <i class='fas fa-paper-plane me-2'></i>Tạo yêu cầu
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<style>
  .required::after {
    content: ' *';
    color: var(--danger-color);
  }

  .form-control:focus,
  .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
  }

  .form-text {
    font-size: 0.875rem;
    color: var(--secondary-color);
  }

  .card-footer {
    border-top: 1px solid var(--border-color);
  }

  #filePreview .alert {
    margin-bottom: 0;
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .priority-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
  }

  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--border-color);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
</style>

<div class='loading-overlay' id='loadingOverlay'>
  <div class='spinner'></div>
</div>

<script>
  // Workflow form schemas data
  const workflowSchemas = {{{workflowsJSON}}};

  document.addEventListener('DOMContentLoaded', function() { 
    const form = document.getElementById('createRequestForm'); 
    const titleInput = document.getElementById('title'); 
    const descriptionInput = document.getElementById('description'); 
    const attachmentInput = document.getElementById('attachment'); 
    const prioritySelect = document.getElementById('priorityId'); 
    const workflowSelect = document.getElementById('workflowId');
    
    // Workflow change handler - Load dynamic form fields
    workflowSelect.addEventListener('change', function() {
      const workflowId = this.value;
      const dynamicContainer = document.getElementById('dynamicFormFields');
      const fieldsContainer = document.getElementById('formFieldsContainer');
      
      // Clear previous fields
      fieldsContainer.innerHTML = '';
      
      if (workflowId) {
        // Find workflow schema
        const workflow = workflowSchemas.find(w => w.WorkflowID == workflowId);
        
        if (workflow && workflow.formFields && workflow.formFields.length > 0) {
          // Show container
          dynamicContainer.style.display = 'block';
          
          // Render fields
          workflow.formFields.forEach(field => {
            const fieldHTML = renderFormField(field);
            fieldsContainer.insertAdjacentHTML('beforeend', fieldHTML);
          });
          
          // Initialize file inputs
          initializeFileInputs();
        } else {
          dynamicContainer.style.display = 'none';
        }
      } else {
        dynamicContainer.style.display = 'none';
      }
    });
    
    // Form validation
    form.addEventListener('submit', function(e) { 
      e.preventDefault(); 
      
      // Validate title 
      const title = titleInput.value.trim(); 
      if (title.length < 3) {
        showError('Tiêu đề phải có ít nhất 3 ký tự'); 
        titleInput.focus(); 
        return; 
      } 
      
      // Validate description 
      const description = descriptionInput.value.trim(); 
      if (description.length < 10) { 
        showError('Mô tả phải có ít nhất 10 ký tự');
        descriptionInput.focus(); 
        return; 
      } 
      
      // Validate dynamic required fields
      const requiredFields = fieldsContainer.querySelectorAll('[required]');
      for (let field of requiredFields) {
        if (!field.value || field.value.trim() === '') {
          const label = field.previousElementSibling?.textContent || 'Trường bắt buộc';
          showError(`${label} không được để trống`);
          field.focus();
          return;
        }
      }
      
      // Show loading 
      showLoading(); 
      
      // Collect form data including dynamic fields
      const formData = new FormData(form);
      
      // Collect dynamic form data as JSON
      const dynamicData = {};
      const dynamicInputs = fieldsContainer.querySelectorAll('input, select, textarea');
      dynamicInputs.forEach(input => {
        if (input.type === 'checkbox') {
          dynamicData[input.name] = input.checked;
        } else if (input.type === 'file') {
          // File handled separately
          if (input.files && input.files.length > 0) {
            dynamicData[input.name] = input.files[0].name;
          }
        } else {
          dynamicData[input.name] = input.value;
        }
      });
      
      // Add dynamic data to formData
      formData.append('formData', JSON.stringify(dynamicData));
      
      // Submit form
      fetch(form.action, { 
        method: 'POST',
        body: formData,
      }) 
      .then(response => response.json()) 
      .then(data => { 
        hideLoading(); 
        if (data.success) {
          showSuccess(data.message); 
          setTimeout(() => { 
            window.location.href = `/requests/${data.requestId}`; 
          }, 1500); 
        } else { 
          showError(data.message || 'Có lỗi xảy ra khi tạo yêu cầu'); 
        } 
      }) 
      .catch(error => { 
        hideLoading();
        console.error('Error:', error); 
        showError('Có lỗi xảy ra khi gửi yêu cầu');
      }); 
    }); 
    
    // File upload preview 
    attachmentInput.addEventListener('change', function(e) { 
      const file = e.target.files[0]; 
      const preview = document.getElementById('filePreview'); 
      const fileName = document.getElementById('fileName'); 
      const fileSize = document.getElementById('fileSize'); 
      
      if (file) { 
        // Check file size (10MB) 
        if (file.size > 10 * 1024 * 1024) { 
          showError('File quá lớn. Vui lòng chọn file nhỏ hơn 10MB'); 
          this.value = ''; 
          return; 
        } 
        fileName.textContent = file.name;
        fileSize.textContent = `(${formatFileSize(file.size)})`; 
        preview.style.display = 'block'; 
      } else { 
        preview.style.display = 'none'; 
      } 
    }); 
    
    // Priority color indicator 
    prioritySelect.addEventListener('change', function() { 
      const selectedOption = this.options[this.selectedIndex]; 
      const color = selectedOption.getAttribute('data-color'); 
      // Update select background color
      if (color) { 
        this.style.borderLeftColor = color; 
        this.style.borderLeftWidth = '4px'; 
      } else { 
        this.style.borderLeftColor = ''; 
        this.style.borderLeftWidth = ''; 
      } 
    }); 
    
    // Auto-save draft functionality 
    let draftTimeout; 
    const draftInputs = [titleInput, descriptionInput, prioritySelect]; 
    draftInputs.forEach(input => { 
      input.addEventListener('input', function() { 
        clearTimeout(draftTimeout);
        draftTimeout = setTimeout(saveDraftAuto, 30000); // Auto-save after 30 seconds
      }); 
    }); 
  }); 
  
  // Render form field based on type
  function renderFormField(field) {
    const required = field.required ? 'required' : '';
    const requiredLabel = field.required ? '<span class="text-danger">*</span>' : '';
    const helpText = field.helpText ? `<div class="form-text">${field.helpText}</div>` : '';
    const fieldName = `field_${field.name}`;
    
    let fieldHTML = `<div class="mb-3 dynamic-field">`;
    
    switch(field.type) {
      case 'text':
      case 'email':
      case 'number':
      case 'date':
        fieldHTML += `
          <label for="${fieldName}" class="form-label">${field.label} ${requiredLabel}</label>
          <input 
            type="${field.type}" 
            class="form-control" 
            id="${fieldName}" 
            name="${fieldName}" 
            placeholder="${field.placeholder || ''}"
            ${required}
            ${field.min !== undefined ? `min="${field.min}"` : ''}
            ${field.max !== undefined ? `max="${field.max}"` : ''}
            ${field.step !== undefined ? `step="${field.step}"` : ''}
          />
          ${helpText}
        `;
        break;
        
      case 'textarea':
        fieldHTML += `
          <label for="${fieldName}" class="form-label">${field.label} ${requiredLabel}</label>
          <textarea 
            class="form-control" 
            id="${fieldName}" 
            name="${fieldName}" 
            rows="${field.rows || 3}"
            placeholder="${field.placeholder || ''}"
            ${required}
          ></textarea>
          ${helpText}
        `;
        break;
        
      case 'select':
        fieldHTML += `
          <label for="${fieldName}" class="form-label">${field.label} ${requiredLabel}</label>
          <select class="form-select" id="${fieldName}" name="${fieldName}" ${required}>
            <option value="">${field.placeholder || 'Chọn...'}</option>
            ${field.options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
          </select>
          ${helpText}
        `;
        break;
        
      case 'radio':
        fieldHTML += `
          <label class="form-label">${field.label} ${requiredLabel}</label>
          <div>
            ${field.options.map((opt, idx) => `
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  name="${fieldName}" 
                  id="${fieldName}_${idx}" 
                  value="${opt.value}"
                  ${required && idx === 0 ? 'required' : ''}
                />
                <label class="form-check-label" for="${fieldName}_${idx}">
                  ${opt.label}
                </label>
              </div>
            `).join('')}
          </div>
          ${helpText}
        `;
        break;
        
      case 'checkbox':
        fieldHTML += `
          <div class="form-check">
            <input 
              class="form-check-input" 
              type="checkbox" 
              id="${fieldName}" 
              name="${fieldName}" 
              ${required}
            />
            <label class="form-check-label" for="${fieldName}">
              ${field.label} ${requiredLabel}
            </label>
          </div>
          ${helpText}
        `;
        break;
        
      case 'file':
        fieldHTML += `
          <label for="${fieldName}" class="form-label">${field.label} ${requiredLabel}</label>
          <input 
            type="file" 
            class="form-control dynamic-file-input" 
            id="${fieldName}" 
            name="${fieldName}" 
            ${field.accept ? `accept="${field.accept}"` : ''}
            ${required}
          />
          ${helpText}
        `;
        break;
    }
    
    fieldHTML += `</div>`;
    return fieldHTML;
  }
  
  function initializeFileInputs() {
    const fileInputs = document.querySelectorAll('.dynamic-file-input');
    fileInputs.forEach(input => {
      input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.size > 10 * 1024 * 1024) {
          showError('File quá lớn. Vui lòng chọn file nhỏ hơn 10MB');
          this.value = '';
        }
      });
    });
  }
  
  function removeFile() {
    document.getElementById('attachment').value = '';
    document.getElementById('filePreview').style.display = 'none'; 
  } 
  
  function formatFileSize(bytes) { 
    if (bytes === 0) return '0 Bytes'; 
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB']; 
    const i = Math.floor(Math.log(bytes) / Math.log(k)); 
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]; 
  } 
  
  function saveDraft() { 
    const formData = new FormData(document.getElementById('createRequestForm'));
    formData.append('isDraft', 'true'); 
    fetch('/requests/draft', { 
      method: 'POST',
      body: formData 
    }) 
    .then(response => response.json()) 
    .then(data => { 
      if (data.success) { 
        showSuccess('Đã lưu nháp thành công'); 
      } else {
        showError('Không thể lưu nháp'); 
      } 
    }) 
    .catch(error => { 
      console.error('Draft save error:', error); 
    }); 
  } 
  
  function saveDraftAuto() { 
    const title = document.getElementById('title').value.trim(); 
    const description = document.getElementById('description').value.trim(); 
    if (title || description) { 
      saveDraft(); 
    } 
  } 
  
  function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex'; 
  } 
  
  function hideLoading() { 
    document.getElementById('loadingOverlay').style.display = 'none'; 
  } 
  
  function showSuccess(message) { 
    // Create toast notification 
    const toast = document.createElement('div'); 
    toast.className = 'alert alert-success alert-dismissible fade show position-fixed'; 
    toast.style.top = '20px';
    toast.style.right = '20px'; 
    toast.style.zIndex = '9999'; 
    toast.innerHTML = `
      <i class="fas fa-check-circle me-2"></i>${message} 
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button> 
    `;
    document.body.appendChild(toast); 
    // Auto remove after 5 seconds 
    setTimeout(() => { 
      if (toast.parentNode) { 
        toast.parentNode.removeChild(toast); 
      } 
    }, 5000);
  } 
  
  function showError(message) { 
    // Create toast notification 
    const toast = document.createElement('div'); 
    toast.className = 'alert alert-danger alert-dismissible fade show position-fixed'; 
    toast.style.top = '20px';
    toast.style.right = '20px'; 
    toast.style.zIndex = '9999'; 
    toast.innerHTML = `
      <i class="fas fa-exclamation-circle me-2"></i>${message} 
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button> 
    `;
    document.body.appendChild(toast); 
    // Auto remove after 5 seconds 
    setTimeout(() => { 
      if (toast.parentNode) { 
        toast.parentNode.removeChild(toast); 
      } 
    }, 5000);
  }
</script>