<link rel="stylesheet" href="/css/modern-table.css">

<div class="content-header">
    <div>
        <h1 class="page-title">Bản nháp</h1>
        <p class="page-subtitle">Danh sách các yêu cầu đã lưu nháp</p>
    </div>
    <div class="content-actions">
        <a href="/requests/create" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Tạo yêu cầu mới
        </a>
    </div>
</div>

{{#if error}}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-circle me-2"></i>{{error}}
</div>
{{/if}}

<div class="modern-table-container">
    <!-- Table Header -->
    <div class="table-header-section">
        <div class="table-title-wrapper">
            <div>
                <h2 class="table-title">
                    <i class="fas fa-file-alt" style="color: var(--table-primary);"></i>
                    Bản nháp
                </h2>
                <p class="table-subtitle">{{pagination.totalRecords}} bản nháp</p>
            </div>
        </div>
        <div class="table-actions">
            <button class="btn-modern btn-modern-primary" onclick="window.location.href='/requests/create'">
                <i class="fas fa-plus"></i>
                Tạo yêu cầu mới
            </button>
        </div>
    </div>

    <!-- Table -->
    {{#if drafts.length}}
    <div class="table-responsive">
        <table class="modern-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="table-checkbox" id="selectAll">
                    </th>
                    <th style="width: 80px;">ID</th>
                    <th class="sortable" data-sort="title">Tiêu đề</th>
                    <th class="sortable text-center" style="width: 130px;" data-sort="priority">Độ ưu tiên</th>
                    <th class="sortable" style="width: 160px;" data-sort="updated">Cập nhật lúc</th>
                    <th class="text-center" style="width: 200px;">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {{#each drafts}}
                <tr>
                    <td>
                        <input type="checkbox" class="table-checkbox" value="{{RequestID}}">
                    </td>
                    <td>
                        <span class="table-cell-id">#{{RequestID}}</span>
                    </td>
                    <td>
                        <div style="max-width: 450px;">
                            <div class="table-cell-name">
                                <i class="fas fa-edit" style="color: var(--table-warning); margin-right: 6px;"></i>
                                {{Title}}
                            </div>
                            {{#if Description}}
                            <div class="table-cell-secondary" style="margin-top: 4px;">
                                {{substring Description 0 100}}...
                            </div>
                            {{/if}}
                        </div>
                    </td>
                    <td class="text-center">
                        {{#ifEquals PriorityName "Cao"}}
                        <span class="table-status-badge status-danger">
                            <i class="fas fa-circle"></i>
                            {{PriorityName}}
                        </span>
                        {{else}}{{#ifEquals PriorityName "Trung bình"}}
                        <span class="table-status-badge status-warning">
                            <i class="fas fa-circle"></i>
                            {{PriorityName}}
                        </span>
                        {{else}}
                        <span class="table-status-badge status-info">
                            <i class="fas fa-circle"></i>
                            {{PriorityName}}
                        </span>
                        {{/ifEquals}}{{/ifEquals}}
                    </td>
                    <td>
                        <span class="table-cell-secondary">
                            <i class="far fa-clock" style="margin-right: 4px;"></i>
                            {{formatDate UpdatedAt}}
                        </span>
                    </td>
                    <td>
                        <div class="table-actions-cell">
                            <button class="table-action-btn action-view" title="Xem"
                                    onclick="window.location.href='/requests/{{RequestID}}'">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="table-action-btn action-edit" title="Chỉnh sửa"
                                    onclick="window.location.href='/requests/{{RequestID}}/edit'">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="table-action-btn action-send" title="Gửi yêu cầu"
                                    style="background: linear-gradient(135deg, #10B981, #059669); color: white;"
                                    onclick="publishDraft({{RequestID}})">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button class="table-action-btn action-delete" title="Xóa"
                                    onclick="deleteDraft({{RequestID}})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {{#if pagination.showPagination}}
    <div class="table-pagination">
        <div class="pagination-info">
            <span>{{pagination.totalRecords}} bản nháp</span>
            <i class="fas fa-sync-alt" onclick="location.reload()" 
               style="margin-left: 12px; cursor: pointer; color: var(--table-text-secondary);" 
               title="Làm mới"></i>
        </div>
        <div class="pagination-controls">
            <button class="pagination-btn" {{#unless pagination.hasPrevious}}disabled{{/unless}}
                    onclick="goToPage({{subtract pagination.currentPage 1}})">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <button class="pagination-btn active">
                {{pagination.currentPage}}
            </button>
            
            <button class="pagination-btn" {{#unless pagination.hasNext}}disabled{{/unless}}
                    onclick="goToPage({{add pagination.currentPage 1}})">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    {{/if}}
    {{else}}
    <div class="table-empty-state">
        <div class="table-empty-icon">
            <i class="fas fa-file-alt"></i>
        </div>
        <div class="table-empty-text">Chưa có bản nháp nào</div>
        <div class="table-empty-subtext">
            Khi bạn lưu nháp yêu cầu, chúng sẽ xuất hiện ở đây.
        </div>
        <button class="btn-modern btn-modern-primary" style="margin-top: 20px;"
                onclick="window.location.href='/requests/create'">
            <i class="fas fa-plus"></i>
            Tạo yêu cầu mới
        </button>
    </div>
    {{/if}}
</div>

<script>
// Select all checkbox
document.getElementById('selectAll')?.addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.modern-table tbody .table-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// Sorting
document.querySelectorAll('.sortable').forEach(th => {
    th.addEventListener('click', function() {
        const tbody = this.closest('table').querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length === 0) return;
        
        const isAsc = this.classList.contains('sorted-asc');
        document.querySelectorAll('.sortable').forEach(t => {
            t.classList.remove('sorted-asc', 'sorted-desc');
        });
        this.classList.add(isAsc ? 'sorted-desc' : 'sorted-asc');
        
        const colIndex = Array.from(this.parentElement.children).indexOf(this);
        rows.sort((a, b) => {
            const aText = a.cells[colIndex]?.textContent.trim() || '';
            const bText = b.cells[colIndex]?.textContent.trim() || '';
            return isAsc ? bText.localeCompare(aText) : aText.localeCompare(bText);
        });
        
        rows.forEach(row => tbody.appendChild(row));
    });
});

// Pagination
function goToPage(page) {
    window.location.href = `/requests/drafts?page=${page}`;
}

// Publish draft
async function publishDraft(draftId) {
    if (!confirm('Bạn có chắc muốn gửi yêu cầu này? Sau khi gửi, yêu cầu sẽ không còn ở dạng nháp.')) {
        return;
    }

    try {
        const response = await fetch(`/requests/drafts/${draftId}/publish`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert(data.message);
            window.location.href = `/requests/${data.requestId}`;
        } else {
            alert(data.message || 'Có lỗi xảy ra');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Có lỗi xảy ra khi gửi yêu cầu');
    }
}

// Delete draft
async function deleteDraft(draftId) {
    if (!confirm('Bạn có chắc muốn xóa bản nháp này?')) {
        return;
    }

    try {
        const response = await fetch(`/requests/${draftId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert(data.message);
            window.location.reload();
        } else {
            alert(data.message || 'Có lỗi xảy ra');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Có lỗi xảy ra khi xóa bản nháp');
    }
}
</script>
