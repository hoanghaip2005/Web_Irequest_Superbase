<link rel="stylesheet" href="/css/modern-table.css">

<div class="assigned-requests-container">
    <!-- Header Section -->
    <div class="content-header">
        <div>
            <h1 class="page-title">Yêu cầu được giao</h1>
            <p class="page-subtitle">Quản lý và xử lý các yêu cầu được giao cho bạn</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Tổng số yêu cầu</h6>
                            <h3 class="mb-0">{{stats.total}}</h3>
                        </div>
                        <div class="stat-icon pending">
                            <i class="fas fa-clipboard-list text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Ưu tiên cao</h6>
                            <h3 class="mb-0">{{stats.urgent}}</h3>
                        </div>
                        <div class="stat-icon overdue">
                            <i class="fas fa-exclamation-triangle text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Đang xử lý</h6>
                            <h3 class="mb-0">{{stats.inProgress}}</h3>
                        </div>
                        <div class="stat-icon processing">
                            <i class="fas fa-spinner text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Đã hoàn thành</h6>
                            <h3 class="mb-0">{{stats.completed}}</h3>
                        </div>
                        <div class="stat-icon completed">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modern Table Container -->
    <div class="modern-table-container">
        <!-- Table Header -->
        <div class="table-header-section">
            <div class="table-title-wrapper">
                <div>
                    <h2 class="table-title">
                        <i class="fas fa-user-check" style="color: var(--table-primary);"></i>
                        Yêu cầu được giao
                    </h2>
                    <p class="table-subtitle">Danh sách yêu cầu được giao cho bạn xử lý</p>
                </div>
            </div>
            <div class="table-actions">
                <button class="btn-modern btn-modern-secondary" onclick="exportToExcel('assigned', getCurrentFilters())">
                    <i class="fas fa-file-excel"></i>
                    Xuất Excel
                </button>
                <button class="btn-modern btn-modern-secondary" onclick="exportToPDF('assigned', getCurrentFilters())">
                    <i class="fas fa-file-pdf"></i>
                    Xuất PDF
                </button>
                <button class="btn-modern btn-modern-secondary" onclick="printRequests()">
                    <i class="fas fa-print"></i>
                    In
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="table-filter-bar">
            <div class="filter-search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="tableSearch" name="search" value="{{filters.search}}" 
                       placeholder="Tìm kiếm theo tiêu đề, mô tả...">
            </div>

            <select class="filter-select" id="statusFilter" name="status">
                <option value="">Tất cả trạng thái</option>
                {{#each statuses}}
                <option value="{{StatusID}}" {{#ifEquals StatusID ../filters.status}}selected{{/ifEquals}}>
                    {{StatusName}}
                </option>
                {{/each}}
            </select>

            <select class="filter-select" id="priorityFilter" name="priority">
                <option value="">Tất cả độ ưu tiên</option>
                {{#each priorities}}
                <option value="{{PriorityID}}" {{#ifEquals PriorityID ../filters.priority}}selected{{/ifEquals}}>
                    {{PriorityName}}
                </option>
                {{/each}}
            </select>

            <button class="filter-btn" onclick="applyFilters()">
                <i class="fas fa-filter"></i>
                Lọc
            </button>

            <button class="filter-btn" onclick="clearFilters()">
                <i class="fas fa-times"></i>
                Xóa bộ lọc
            </button>
        </div>

        <!-- Table -->
        {{#if requests.length}}
        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" class="table-checkbox" id="selectAll">
                        </th>
                        <th style="width: 80px;">ID</th>
                        <th class="sortable" data-sort="title">Tiêu đề</th>
                        <th style="width: 150px;">Người tạo</th>
                        <th class="sortable text-center" style="width: 130px;" data-sort="status">Trạng thái</th>
                        <th class="sortable text-center" style="width: 130px;" data-sort="priority">Độ ưu tiên</th>
                        <th class="sortable" style="width: 140px;" data-sort="created">Ngày tạo</th>
                        <th class="sortable" style="width: 140px;" data-sort="assigned">Ngày giao</th>
                        <th class="text-center" style="width: 160px;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each requests}}
                    <tr {{#if IsOverdue}}style="background-color: #FFF3CD;"{{/if}}>
                        <td>
                            <input type="checkbox" class="table-checkbox" value="{{RequestID}}">
                        </td>
                        <td>
                            <span class="table-cell-id">#{{RequestID}}</span>
                        </td>
                        <td>
                            <div style="max-width: 350px;">
                                <div class="table-cell-name">
                                    {{#if AttachmentURL}}
                                    <i class="fas fa-paperclip" style="color: var(--table-text-secondary); margin-right: 6px;"></i>
                                    {{/if}}
                                    {{#if IsOverdue}}
                                    <i class="fas fa-exclamation-triangle" style="color: #F59E0B; margin-right: 6px;" title="Quá hạn"></i>
                                    {{/if}}
                                    {{Title}}
                                </div>
                                {{#if Description}}
                                <div class="table-cell-secondary" style="margin-top: 4px;">
                                    {{substring Description 0 70}}...
                                </div>
                                {{/if}}
                            </div>
                        </td>
                        <td>
                            <div class="table-cell-icon">
                                <div style="width: 32px; height: 32px; background: var(--table-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                                    {{substring CreatedByUser 0 1}}
                                </div>
                                <span class="table-cell-secondary">{{CreatedByUser}}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            {{#if IsStatusFinal}}
                            <span class="table-status-badge status-success">
                                <i class="fas fa-circle"></i>
                                {{StatusName}}
                            </span>
                            {{else}}
                            <span class="table-status-badge status-warning">
                                <i class="fas fa-circle"></i>
                                {{StatusName}}
                            </span>
                            {{/if}}
                        </td>
                        <td class="text-center">
                            {{#ifEquals PriorityName "Cao"}}
                            <span class="table-status-badge status-danger">
                                <i class="fas fa-circle"></i>
                                {{PriorityName}}
                            </span>
                            {{else}}{{#ifEquals PriorityName "Trung bình"}}
                            <span class="table-status-badge status-warning">
                                <i class="fas fa-circle"></i>
                                {{PriorityName}}
                            </span>
                            {{else}}
                            <span class="table-status-badge status-info">
                                <i class="fas fa-circle"></i>
                                {{PriorityName}}
                            </span>
                            {{/ifEquals}}{{/ifEquals}}
                        </td>
                        <td>
                            <span class="table-cell-secondary">{{formatDate CreatedAt}}</span>
                        </td>
                        <td>
                            <span class="table-cell-secondary">{{#if AssignedAt}}{{formatDate AssignedAt}}{{else}}-{{/if}}</span>
                        </td>
                        <td>
                            <div class="table-actions-cell">
                                <button class="table-action-btn action-view" title="Xem chi tiết" 
                                        onclick="window.location.href='/requests/{{RequestID}}'">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="table-action-btn action-edit" title="Xử lý"
                                        onclick="window.location.href='/requests/{{RequestID}}'">
                                    <i class="fas fa-tasks"></i>
                                </button>
                                <button class="table-action-btn action-print" title="In"
                                        onclick="window.print()">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {{#if pagination.totalPages}}
        <div class="table-pagination">
            <div class="pagination-info">
                <span>{{#if pagination.totalRecords}}{{pagination.totalRecords}}{{else}}0{{/if}} kết quả</span>
                <i class="fas fa-sync-alt" onclick="location.reload()" 
                   style="margin-left: 12px; cursor: pointer; color: var(--table-text-secondary);" 
                   title="Làm mới"></i>
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" {{#unless pagination.hasPrevious}}disabled{{/unless}}
                        onclick="goToPage({{pagination.previousPage}})">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                {{#each pagination.pages}}
                <button class="pagination-btn {{#if active}}active{{/if}}"
                        onclick="goToPage({{number}})">
                    {{number}}
                </button>
                {{/each}}
                
                <button class="pagination-btn" {{#unless pagination.hasNext}}disabled{{/unless}}
                        onclick="goToPage({{pagination.nextPage}})">
                    <i class="fas fa-chevron-right"></i>
                </button>
                
                <select class="pagination-select" id="itemsPerPage" onchange="changePageSize(this.value)">
                    <option value="10">10 hàng/trang</option>
                    <option value="20" selected>20 hàng/trang</option>
                    <option value="50">50 hàng/trang</option>
                </select>
            </div>
        </div>
        {{/if}}
        {{else}}
        <div class="table-empty-state">
            <div class="table-empty-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="table-empty-text">Không có yêu cầu được giao</div>
            <div class="table-empty-subtext">
                {{#if filters.search}}
                Không tìm thấy yêu cầu phù hợp với từ khóa "{{filters.search}}"
                {{else}}
                Bạn chưa được giao yêu cầu nào.
                {{/if}}
            </div>
        </div>
        {{/if}}
    </div>
</div>

<script>
// Filter functions
function getCurrentFilters() {
    const params = new URLSearchParams();
    const search = document.getElementById('tableSearch')?.value;
    const status = document.getElementById('statusFilter')?.value;
    const priority = document.getElementById('priorityFilter')?.value;
    
    if (search) params.set('search', search);
    if (status) params.set('status', status);
    if (priority) params.set('priority', priority);
    
    return params;
}

function applyFilters() {
    const params = getCurrentFilters();
    params.set('page', 1);
    window.location.search = params.toString();
}

function clearFilters() {
    window.location.href = '/requests/assigned';
}

// Search on Enter
document.getElementById('tableSearch')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') applyFilters();
});

// Auto-submit on filter change
document.getElementById('statusFilter')?.addEventListener('change', applyFilters);
document.getElementById('priorityFilter')?.addEventListener('change', applyFilters);

// Select all checkbox
document.getElementById('selectAll')?.addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.modern-table tbody .table-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// Sorting
document.querySelectorAll('.sortable').forEach(th => {
    th.addEventListener('click', function() {
        const tbody = this.closest('table').querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length === 0 || rows[0].cells.length === 1) return;
        
        const isAsc = this.classList.contains('sorted-asc');
        document.querySelectorAll('.sortable').forEach(t => {
            t.classList.remove('sorted-asc', 'sorted-desc');
        });
        this.classList.add(isAsc ? 'sorted-desc' : 'sorted-asc');
        
        const colIndex = Array.from(this.parentElement.children).indexOf(this);
        rows.sort((a, b) => {
            const aText = a.cells[colIndex]?.textContent.trim() || '';
            const bText = b.cells[colIndex]?.textContent.trim() || '';
            return isAsc ? bText.localeCompare(aText) : aText.localeCompare(bText);
        });
        
        rows.forEach(row => tbody.appendChild(row));
    });
});

// Pagination functions
function goToPage(page) {
    const params = getCurrentFilters();
    params.set('page', page);
    window.location.search = params.toString();
}

function changePageSize(size) {
    const params = getCurrentFilters();
    params.set('limit', size);
    params.set('page', 1);
    window.location.search = params.toString();
}
</script>

<script src="/js/export.js"></script>