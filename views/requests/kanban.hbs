<link rel="stylesheet" href="/css/modern-table.css">
<link rel="stylesheet" href="/css/kanban.css">

<div class="content-header">
    <div>
        <h1 class="page-title">
            <i class="fas fa-th me-2"></i>
            {{#if user.isAdmin}}Kanban Board - T·∫•t c·∫£ y√™u c·∫ßu{{else}}Kanban Board - Y√™u c·∫ßu c·ªßa t√¥i{{/if}}
        </h1>
        <p class="page-subtitle">
            <i class="fas fa-hand-rock"></i>
            K√©o th·∫£ ƒë·ªÉ thay ƒë·ªïi tr·∫°ng th√°i y√™u c·∫ßu
            {{#if user.isAdmin}}
            <span class="badge bg-danger ms-2">
                <i class="fas fa-shield-alt me-1"></i>Admin - To√†n quy·ªÅn x·ª≠ l√Ω
            </span>
            {{/if}}
        </p>
    </div>
    <div class="content-actions">
        <div class="d-inline-flex gap-2 me-2">
            <a href="/requests/my?view=list" class="btn-modern btn-modern-secondary">
                <i class="fas fa-list"></i>
                Danh s√°ch
            </a>
            <a href="/requests/my/kanban" class="btn-modern btn-modern-primary">
                <i class="fas fa-th"></i>
                Kanban
            </a>
            <a href="/requests/my?view=calendar" class="btn-modern btn-modern-secondary">
                <i class="fas fa-calendar-alt"></i>
                L·ªãch
            </a>
        </div>
        <a href="/requests/create" class="btn-modern btn-modern-primary">
            <i class="fas fa-plus"></i>
            T·∫°o y√™u c·∫ßu m·ªõi
        </a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-primary bg-gradient text-white rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 48px; height: 48px;">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="text-muted small">T·ªïng s·ªë</div>
                        <div class="fs-5 fw-bold text-primary">{{stats.total}}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-warning bg-gradient text-white rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 48px; height: 48px;">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="text-muted small">Ch·ªù x·ª≠ l√Ω</div>
                        <div class="fs-5 fw-bold text-warning">{{stats.pending}}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-info bg-gradient text-white rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 48px; height: 48px;">
                            <i class="fas fa-spinner"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="text-muted small">ƒêang x·ª≠ l√Ω</div>
                        <div class="fs-5 fw-bold text-info">{{stats.inProgress}}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-success bg-gradient text-white rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 48px; height: 48px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="text-muted small">Ho√†n th√†nh</div>
                        <div class="fs-5 fw-bold text-success">{{stats.completed}}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kanban Board -->
<div class="modern-kanban-board">
    <div class="kanban-container">
        {{#each statuses}}
        <div class="kanban-column" data-status-id="{{StatusID}}">
            <div class="kanban-column-header">
                <div class="kanban-column-title">
                    <div class="kanban-icon {{#if IsFinal}}status-completed{{else}}status-pending{{/if}}">
                        <i class="fas fa-{{#if IsFinal}}check-circle{{else}}clock{{/if}}"></i>
                    </div>
                    <div class="kanban-title-text">
                        <h5>{{StatusName}}</h5>
                        <span class="kanban-count">{{requests.length}} y√™u c·∫ßu</span>
                    </div>
                </div>
            </div>
            <div class="kanban-column-body" id="column-{{StatusID}}" data-status-id="{{StatusID}}">
                {{#if requests.length}}
                    {{#each requests}}
                    <div class="kanban-card" 
                         data-request-id="{{RequestID}}" 
                         data-is-assigned="{{#if AssignedTo}}{{#ifEquals AssignedTo ../user.Id}}true{{else}}false{{/ifEquals}}{{else}}false{{/if}}"
                         data-creator-id="{{CreatedBy}}"
                         draggable="true">
                        <div class="kanban-card-header">
                            <div class="kanban-card-id">
                                <span class="table-cell-id">#{{RequestID}}</span>
                                {{#if ../user.isAdmin}}
                                    {{#if CreatorEmail}}
                                    <span class="kanban-admin-badge" title="B·∫°n c√≥ quy·ªÅn x·ª≠ l√Ω y√™u c·∫ßu n√†y">
                                        <i class="fas fa-user-shield"></i>
                                    </span>
                                    {{/if}}
                                {{/if}}
                            </div>
                            {{#ifEquals PriorityName 'Cao'}}
                            <span class="table-status-badge status-danger">
                                <i class="fas fa-flag"></i>
                                {{PriorityName}}
                            </span>
                            {{else}}{{#ifEquals PriorityName 'Trung b√¨nh'}}
                            <span class="table-status-badge status-warning">
                                <i class="fas fa-flag"></i>
                                {{PriorityName}}
                            </span>
                            {{else}}
                            <span class="table-status-badge status-info">
                                <i class="fas fa-flag"></i>
                                {{PriorityName}}
                            </span>
                            {{/ifEquals}}{{/ifEquals}}
                        </div>
                        
                        <div class="kanban-card-body">
                            <h6 class="kanban-card-title">
                                <a href="/requests/{{RequestID}}">
                                    {{Title}}
                                </a>
                            </h6>
                            {{#if Description}}
                            <p class="kanban-card-description">
                                {{substring Description 0 100}}{{#if (gt (length Description) 100)}}...{{/if}}
                            </p>
                            {{/if}}
                        </div>
                        
                        <div class="kanban-card-footer">
                            <div class="kanban-card-meta">
                                <div class="kanban-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>{{formatDate CreatedAt}}</span>
                                </div>
                                {{#if ../user.isAdmin}}
                                    {{#if CreatorEmail}}
                                    <div class="kanban-meta-item">
                                        <i class="fas fa-user"></i>
                                        <span>{{CreatorEmail}}</span>
                                    </div>
                                    {{/if}}
                                {{/if}}
                                {{#if AssignedToEmail}}
                                <div class="kanban-meta-item">
                                    <i class="fas fa-user-check"></i>
                                    <span>{{AssignedToEmail}}</span>
                                </div>
                                {{/if}}
                            </div>
                            <button class="kanban-view-btn view-detail-btn" 
                                    data-request-id="{{RequestID}}"
                                    title="Xem chi ti·∫øt">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    {{/each}}
                {{else}}
                <div class="kanban-empty">
                    <div class="table-empty-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <div class="table-empty-text">Kh√¥ng c√≥ y√™u c·∫ßu</div>
                </div>
                {{/if}}
            </div>
        </div>
        {{/each}}
    </div>
</div>

<!-- Modal: Confirmation for Status Change -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusChangeModalLabel">
                    <i class="fas fa-exchange-alt me-2"></i>X·ª≠ l√Ω y√™u c·∫ßu
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Y√™u c·∫ßu: <strong id="modalRequestTitle"></strong><br>
                    <small>T·ª´ tr·∫°ng th√°i <strong id="modalOldStatus"></strong> 
                    sang <strong id="modalNewStatus"></strong></small>
                </div>
                
                {{#if user.isAdmin}}
                <div class="alert alert-danger mb-3">
                    <i class="fas fa-shield-alt me-2"></i>
                    <strong>Quy·ªÅn Admin:</strong> B·∫°n c√≥ to√†n quy·ªÅn x·ª≠ l√Ω m·ªçi y√™u c·∫ßu trong h·ªá th·ªëng.
                </div>
                {{/if}}

                <!-- Action Decision -->
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-tasks me-2"></i>H√†nh ƒë·ªông x·ª≠ l√Ω <span class="text-danger">*</span>
                    </label>
                    <div class="d-grid gap-2">
                        <div class="form-check form-check-card">
                            <input class="form-check-input" type="radio" name="actionDecision" id="approveAction" value="approve">
                            <label class="form-check-label card p-3 mb-0 cursor-pointer" for="approveAction">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">Ph√™ duy·ªát</h6>
                                        <small class="text-muted">Ch·∫•p nh·∫≠n v√† chuy·ªÉn sang b∆∞·ªõc ti·∫øp theo</small>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <div class="form-check form-check-card">
                            <input class="form-check-input" type="radio" name="actionDecision" id="rejectAction" value="reject">
                            <label class="form-check-label card p-3 mb-0 cursor-pointer" for="rejectAction">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <i class="fas fa-times-circle"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">T·ª´ ch·ªëi</h6>
                                        <small class="text-muted">Kh√¥ng ch·∫•p nh·∫≠n y√™u c·∫ßu n√†y</small>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <div class="form-check form-check-card">
                            <input class="form-check-input" type="radio" name="actionDecision" id="requestMoreInfoAction" value="request_more_info">
                            <label class="form-check-label card p-3 mb-0 cursor-pointer" for="requestMoreInfoAction">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <i class="fas fa-info-circle"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">Y√™u c·∫ßu b·ªï sung th√¥ng tin</h6>
                                        <small class="text-muted">C·∫ßn th√™m th√¥ng tin t·ª´ ng∆∞·ªùi g·ª≠i</small>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <div class="form-check form-check-card">
                            <input class="form-check-input" type="radio" name="actionDecision" id="justMoveAction" value="just_move">
                            <label class="form-check-label card p-3 mb-0 cursor-pointer" for="justMoveAction">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <i class="fas fa-arrow-right"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">Chuy·ªÉn tr·∫°ng th√°i</h6>
                                        <small class="text-muted">Ch·ªâ c·∫≠p nh·∫≠t tr·∫°ng th√°i m√† kh√¥ng ph√™ duy·ªát</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Note/Reason -->
                <div class="mb-3">
                    <label for="statusChangeNote" class="form-label">
                        <i class="fas fa-comment-dots me-2"></i>
                        <span id="noteLabel">Ghi ch√∫</span>
                        <span class="text-danger">*</span>
                    </label>
                    <textarea 
                        class="form-control" 
                        id="statusChangeNote" 
                        rows="4" 
                        placeholder="Nh·∫≠p ghi ch√∫, l√Ω do ho·∫∑c y√™u c·∫ßu b·ªï sung..."
                        required></textarea>
                    <div class="form-text" id="noteHelpText">Vui l√≤ng m√¥ t·∫£ r√µ l√Ω do thay ƒë·ªïi</div>
                </div>

                <!-- Additional Info Section (for request more info) -->
                <div id="additionalInfoSection" class="mb-3" style="display: none;">
                    <label class="form-label">
                        <i class="fas fa-list-check me-2"></i>Th√¥ng tin c·∫ßn b·ªï sung
                    </label>
                    <div class="card bg-light">
                        <div class="card-body">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="needDocuments">
                                <label class="form-check-label" for="needDocuments">
                                    C·∫ßn b·ªï sung t√†i li·ªáu ƒë√≠nh k√®m
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="needClarification">
                                <label class="form-check-label" for="needClarification">
                                    C·∫ßn l√†m r√µ m√¥ t·∫£ y√™u c·∫ßu
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="needApproval">
                                <label class="form-check-label" for="needApproval">
                                    C·∫ßn x√°c nh·∫≠n t·ª´ c·∫•p tr√™n
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rejection Reason Section -->
                <div id="rejectionReasonSection" class="mb-3" style="display: none;">
                    <label for="rejectionReason" class="form-label text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>L√Ω do t·ª´ ch·ªëi c·ª• th·ªÉ <span class="text-danger">*</span>
                    </label>
                    <textarea 
                        class="form-control border-danger" 
                        id="rejectionReason" 
                        rows="3" 
                        placeholder="Vui l√≤ng n√™u r√µ l√Ω do t·∫°i sao y√™u c·∫ßu b·ªã t·ª´ ch·ªëi..."></textarea>
                    <div class="form-text text-danger">Th√¥ng tin n√†y s·∫Ω ƒë∆∞·ª£c g·ª≠i cho ng∆∞·ªùi t·∫°o y√™u c·∫ßu</div>
                </div>

                <!-- Permission Warning -->
                <div id="permissionWarning" class="alert alert-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>L∆∞u √Ω:</strong> Ch·ªâ ng∆∞·ªùi ƒë∆∞·ª£c ph√¢n c√¥ng x·ª≠ l√Ω ho·∫∑c Admin m·ªõi c√≥ quy·ªÅn th·ª±c hi·ªán h√†nh ƒë·ªông n√†y.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>H·ªßy
                </button>
                <button type="button" class="btn btn-primary" id="confirmStatusChange">
                    <i class="fas fa-check me-2"></i>
                    <span id="confirmButtonText">X√°c nh·∫≠n</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Request Detail Quick View -->
<div class="modal fade" id="requestDetailModal" tabindex="-1" aria-labelledby="requestDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestDetailModalLabel">
                    <i class="fas fa-file-alt me-2"></i>Chi ti·∫øt y√™u c·∫ßu
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="requestDetailContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <a href="#" id="viewFullDetailBtn" class="btn btn-primary" target="_blank">
                    <i class="fas fa-external-link-alt me-2"></i>Xem to√†n b·ªô
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.kanban-board {
    width: 100%;
    overflow-x: auto;
    padding-bottom: 20px;
}

.kanban-container {
    display: flex;
    gap: 20px;
    min-width: fit-content;
    padding: 10px;
}

.kanban-column {
    min-width: 320px;
    max-width: 320px;
    background: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.kanban-column-header {
    padding: 15px;
    border-radius: 8px 8px 0 0;
}

.kanban-column-body {
    padding: 15px;
    min-height: 400px;
    max-height: 70vh;
    overflow-y: auto;
}

.kanban-column-body.drag-over {
    background: #e3f2fd;
    border: 2px dashed #2196F3;
}

.kanban-card {
    background: white;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: grab;
    transition: all 0.3s ease;
}

.kanban-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.kanban-card.dragging {
    opacity: 0.5;
    cursor: grabbing;
}

.kanban-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.kanban-card-header > div {
    display: flex;
    gap: 6px;
    align-items: center;
}

.kanban-card-body {
    margin-bottom: 8px;
}

.kanban-card-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 6px;
    line-height: 1.4;
}

.kanban-card-description {
    font-size: 13px;
    color: #666;
    margin-bottom: 0;
    line-height: 1.4;
}

.kanban-card-footer {
    display: block;
    padding-top: 8px;
    border-top: 1px solid #eee;
}

.kanban-card-footer small {
    font-size: 11px;
}

.kanban-card-actions {
    margin-top: 8px;
}

.kanban-card-actions .btn {
    padding: 4px 8px;
    font-size: 12px;
}

.kanban-empty {
    text-align: center;
    padding: 40px 20px;
}

/* Scrollbar styling */
.kanban-column-body::-webkit-scrollbar {
    width: 6px;
}

.kanban-column-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.kanban-column-body::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.kanban-column-body::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Modal action cards */
.form-check-card {
    position: relative;
}

.form-check-card .form-check-input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.form-check-card .form-check-label.card {
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.form-check-card .form-check-label.card:hover {
    border-color: #dee2e6;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.form-check-card .form-check-input:checked + .form-check-label.card {
    border-color: #0d6efd;
    background-color: #e7f1ff;
    box-shadow: 0 4px 12px rgba(13,110,253,0.2);
}

.form-check-card .form-check-input:checked + .form-check-label.card h6 {
    color: #0d6efd;
}

.cursor-pointer {
    cursor: pointer;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.kanban-card');
    const columns = document.querySelectorAll('.kanban-column-body');
    const statusChangeModal = new bootstrap.Modal(document.getElementById('statusChangeModal'));
    const requestDetailModal = new bootstrap.Modal(document.getElementById('requestDetailModal'));
    
    let pendingStatusChange = null; // Store pending change data

    // View detail button click
    document.querySelectorAll('.view-detail-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const requestId = this.dataset.requestId;
            loadRequestDetail(requestId);
        });
    });

    // Action decision radio buttons
    document.querySelectorAll('input[name="actionDecision"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const rejectionSection = document.getElementById('rejectionReasonSection');
            const additionalInfoSection = document.getElementById('additionalInfoSection');
            const noteLabel = document.getElementById('noteLabel');
            const noteHelpText = document.getElementById('noteHelpText');
            const confirmButtonText = document.getElementById('confirmButtonText');
            const noteField = document.getElementById('statusChangeNote');

            // Reset all sections
            rejectionSection.style.display = 'none';
            additionalInfoSection.style.display = 'none';
            document.getElementById('rejectionReason').required = false;

            // Update based on selected action
            if (this.value === 'approve') {
                noteLabel.textContent = 'Ghi ch√∫ ph√™ duy·ªát';
                noteHelpText.textContent = 'Nh·∫≠p ghi ch√∫ v·ªÅ quy·∫øt ƒë·ªãnh ph√™ duy·ªát';
                noteField.placeholder = 'ƒê√£ ki·ªÉm tra v√† ph√™ duy·ªát y√™u c·∫ßu...';
                confirmButtonText.innerHTML = '<i class="fas fa-check me-2"></i>Ph√™ duy·ªát';
                
            } else if (this.value === 'reject') {
                noteLabel.textContent = 'L√Ω do t·ª´ ch·ªëi';
                noteHelpText.textContent = 'Vui l√≤ng n√™u r√µ l√Ω do t·ª´ ch·ªëi';
                noteField.placeholder = 'Nh·∫≠p l√Ω do t·∫°i sao y√™u c·∫ßu b·ªã t·ª´ ch·ªëi...';
                rejectionSection.style.display = 'block';
                document.getElementById('rejectionReason').required = true;
                confirmButtonText.innerHTML = '<i class="fas fa-times me-2"></i>T·ª´ ch·ªëi';
                
            } else if (this.value === 'request_more_info') {
                noteLabel.textContent = 'Th√¥ng tin c·∫ßn b·ªï sung';
                noteHelpText.textContent = 'M√¥ t·∫£ r√µ th√¥ng tin c·∫ßn ng∆∞·ªùi g·ª≠i b·ªï sung';
                noteField.placeholder = 'Vui l√≤ng b·ªï sung th√¥ng tin v·ªÅ...';
                additionalInfoSection.style.display = 'block';
                confirmButtonText.innerHTML = '<i class="fas fa-info-circle me-2"></i>Y√™u c·∫ßu b·ªï sung';
                
            } else if (this.value === 'just_move') {
                noteLabel.textContent = 'Ghi ch√∫';
                noteHelpText.textContent = 'Nh·∫≠p ghi ch√∫ v·ªÅ thay ƒë·ªïi tr·∫°ng th√°i';
                noteField.placeholder = 'Ghi ch√∫ v·ªÅ vi·ªác chuy·ªÉn tr·∫°ng th√°i...';
                confirmButtonText.innerHTML = '<i class="fas fa-arrow-right me-2"></i>Chuy·ªÉn tr·∫°ng th√°i';
            }
        });
    });

    // Drag start
    cards.forEach(card => {
        card.addEventListener('dragstart', function(e) {
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            e.dataTransfer.setData('request-id', this.dataset.requestId);
            
            // Get request title
            const titleEl = this.querySelector('.kanban-card-title a');
            e.dataTransfer.setData('request-title', titleEl ? titleEl.textContent.trim() : '');
        });

        card.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            columns.forEach(col => col.classList.remove('drag-over'));
        });
    });

    // Drag over columns
    columns.forEach(column => {
        column.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
        });

        column.addEventListener('dragleave', function(e) {
            if (e.target === this) {
                this.classList.remove('drag-over');
            }
        });

        column.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            const requestId = e.dataTransfer.getData('request-id');
            const requestTitle = e.dataTransfer.getData('request-title');
            const newStatusId = this.dataset.statusId;
            const draggedCard = document.querySelector(`[data-request-id="${requestId}"]`);

            if (!draggedCard) return;

            // Get current status
            const oldColumn = draggedCard.closest('.kanban-column-body');
            const oldStatusId = oldColumn.dataset.statusId;

            // Check if status changed
            if (oldStatusId === newStatusId) {
                return;
            }

            // Get status names
            const oldStatusName = oldColumn.closest('.kanban-column').querySelector('.kanban-column-header h5').textContent.trim().split('\n')[0].trim();
            const newStatusName = this.closest('.kanban-column').querySelector('.kanban-column-header h5').textContent.trim().split('\n')[0].trim();

            // Show confirmation modal
            showStatusChangeModal(requestId, requestTitle, oldStatusId, newStatusId, oldStatusName, newStatusName, draggedCard, oldColumn, this);
        });
    });

    function showStatusChangeModal(requestId, requestTitle, oldStatusId, newStatusId, oldStatusName, newStatusName, card, oldColumn, newColumn) {
        // Store pending change
        pendingStatusChange = {
            requestId,
            newStatusId,
            oldStatusId,
            card,
            oldColumn,
            newColumn
        };

        // Update modal content
        document.getElementById('modalRequestTitle').textContent = requestTitle || `#${requestId}`;
        document.getElementById('modalOldStatus').textContent = oldStatusName;
        document.getElementById('modalNewStatus').textContent = newStatusName;
        
        // Reset form
        document.getElementById('statusChangeNote').value = '';
        document.getElementById('rejectionReason').value = '';
        document.getElementById('rejectionReasonSection').style.display = 'none';
        document.getElementById('additionalInfoSection').style.display = 'none';
        document.querySelectorAll('input[name="actionDecision"]').forEach(r => r.checked = false);
        
        // Uncheck additional info checkboxes
        document.getElementById('needDocuments').checked = false;
        document.getElementById('needClarification').checked = false;
        document.getElementById('needApproval').checked = false;

        // Check if user has permission (get from card data attributes)
        const isAssigned = card.dataset.isAssigned === 'true';
        const isAdmin = {{#if user.isAdmin}}true{{else}}false{{/if}};
        
        if (!isAssigned && !isAdmin) {
            document.getElementById('permissionWarning').style.display = 'block';
        } else {
            document.getElementById('permissionWarning').style.display = 'none';
        }

        statusChangeModal.show();
    }

    // Confirm status change
    document.getElementById('confirmStatusChange').addEventListener('click', function() {
        const note = document.getElementById('statusChangeNote').value.trim();
        const actionDecision = document.querySelector('input[name="actionDecision"]:checked');
        
        if (!note) {
            showToast('error', 'Vui l√≤ng nh·∫≠p ghi ch√∫/l√Ω do');
            return;
        }

        if (!actionDecision) {
            showToast('error', 'Vui l√≤ng ch·ªçn h√†nh ƒë·ªông x·ª≠ l√Ω');
            return;
        }

        const rejectionReason = document.getElementById('rejectionReason').value.trim();

        // Validate rejection reason if reject is selected
        if (actionDecision.value === 'reject' && !rejectionReason) {
            showToast('error', 'Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi c·ª• th·ªÉ');
            return;
        }

        // Prepare data
        const data = {
            statusId: pendingStatusChange.newStatusId,
            oldStatusId: pendingStatusChange.oldStatusId,
            note: note,
            action: actionDecision.value
        };

        // Handle different actions
        if (actionDecision.value === 'approve') {
            data.isApproved = true;
            data.actionType = 'approval';
            
        } else if (actionDecision.value === 'reject') {
            data.isApproved = false;
            data.rejectionReason = rejectionReason;
            data.actionType = 'rejection';
            
        } else if (actionDecision.value === 'request_more_info') {
            data.actionType = 'request_more_info';
            data.requestMoreInfo = {
                needDocuments: document.getElementById('needDocuments').checked,
                needClarification: document.getElementById('needClarification').checked,
                needApproval: document.getElementById('needApproval').checked
            };
            
        } else if (actionDecision.value === 'just_move') {
            data.actionType = 'status_change';
        }

        // Call API to update status
        updateRequestStatus(
            pendingStatusChange.requestId,
            data,
            pendingStatusChange.card,
            pendingStatusChange.oldColumn,
            pendingStatusChange.newColumn
        );

        statusChangeModal.hide();
    });

    function updateRequestStatus(requestId, data, card, oldColumn, newColumn) {
        // Show loading
        card.style.opacity = '0.6';
        card.style.pointerEvents = 'none';

        fetch(`/requests/${requestId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Move card to new column
                newColumn.insertBefore(card, newColumn.firstChild);
                
                // Update badges count
                updateColumnCounts(oldColumn, newColumn);
                
                // Show success message based on action
                let message = 'ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i y√™u c·∫ßu';
                let icon = 'check-circle';
                
                switch(data.actionType) {
                    case 'approval':
                        message = '‚úÖ ƒê√£ ph√™ duy·ªát y√™u c·∫ßu th√†nh c√¥ng';
                        icon = 'check-circle';
                        break;
                    case 'rejection':
                        message = '‚ùå ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu';
                        icon = 'times-circle';
                        break;
                    case 'request_more_info':
                        message = 'üìã ƒê√£ y√™u c·∫ßu b·ªï sung th√¥ng tin';
                        icon = 'info-circle';
                        break;
                    case 'status_change':
                        message = '‚û°Ô∏è ƒê√£ chuy·ªÉn tr·∫°ng th√°i y√™u c·∫ßu';
                        icon = 'arrow-right';
                        break;
                }
                
                showToast('success', message);
                
                // Reset card style
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
                
                // Clear pending change
                pendingStatusChange = null;
                
                // Reload page after 2 seconds to update all data
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                throw new Error(result.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + error.message);
            
            // Reset card style
            card.style.opacity = '1';
            card.style.pointerEvents = 'auto';
        });
    }

    function updateColumnCounts(oldColumn, newColumn) {
        const oldColumnHeader = oldColumn.closest('.kanban-column').querySelector('.kanban-column-header .badge');
        const newColumnHeader = newColumn.closest('.kanban-column').querySelector('.kanban-column-header .badge');
        
        const oldCount = oldColumn.querySelectorAll('.kanban-card').length;
        const newCount = newColumn.querySelectorAll('.kanban-card').length;
        
        oldColumnHeader.textContent = oldCount;
        newColumnHeader.textContent = newCount;

        // Show/hide empty state
        updateEmptyState(oldColumn);
        updateEmptyState(newColumn);
    }

    function updateEmptyState(column) {
        const cards = column.querySelectorAll('.kanban-card');
        let emptyState = column.querySelector('.kanban-empty');
        
        if (cards.length === 0 && !emptyState) {
            emptyState = document.createElement('div');
            emptyState.className = 'kanban-empty';
            emptyState.innerHTML = `
                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">Kh√¥ng c√≥ y√™u c·∫ßu</p>
            `;
            column.appendChild(emptyState);
        } else if (cards.length > 0 && emptyState) {
            emptyState.remove();
        }
    }

    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 5000);
    }

    function loadRequestDetail(requestId) {
        const contentDiv = document.getElementById('requestDetailContent');
        const viewBtn = document.getElementById('viewFullDetailBtn');
        
        // Show loading
        contentDiv.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        // Update view full button
        viewBtn.href = `/requests/${requestId}`;
        
        // Load request data
        fetch(`/requests/${requestId}/api`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.request) {
                    const req = data.request;
                    contentDiv.innerHTML = `
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="mb-3">${req.Title}</h5>
                                <div class="mb-3">
                                    <span class="badge bg-${req.StatusName === 'Ho√†n th√†nh' ? 'success' : req.StatusName === 'ƒêang x·ª≠ l√Ω' ? 'info' : req.StatusName === 'T·ª´ ch·ªëi' ? 'danger' : 'warning'}">
                                        ${req.StatusName || 'N/A'}
                                    </span>
                                    <span class="badge bg-${req.PriorityName === 'Cao' ? 'danger' : req.PriorityName === 'Trung b√¨nh' ? 'warning' : 'info'}">
                                        ${req.PriorityName || 'N/A'}
                                    </span>
                                </div>
                                <div class="mb-3">
                                    <strong>M√¥ t·∫£:</strong>
                                    <p class="mt-2">${req.Description || '<em class="text-muted">Kh√¥ng c√≥ m√¥ t·∫£</em>'}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Th√¥ng tin</h6>
                                        <p class="mb-2"><small class="text-muted">Ng∆∞·ªùi t·∫°o:</small><br>${req.CreatorEmail || 'N/A'}</p>
                                        <p class="mb-2"><small class="text-muted">Ng∆∞·ªùi x·ª≠ l√Ω:</small><br>${req.AssignedToEmail || '<em>Ch∆∞a ph√¢n c√¥ng</em>'}</p>
                                        <p class="mb-2"><small class="text-muted">Ng√†y t·∫°o:</small><br>${new Date(req.CreatedAt).toLocaleDateString('vi-VN')}</p>
                                        <p class="mb-0"><small class="text-muted">C·∫≠p nh·∫≠t:</small><br>${new Date(req.UpdatedAt).toLocaleDateString('vi-VN')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    contentDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Kh√¥ng th·ªÉ t·∫£i th√¥ng tin y√™u c·∫ßu
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading request:', error);
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}
                    </div>
                `;
            });
        
        requestDetailModal.show();
    }
});
</script>
