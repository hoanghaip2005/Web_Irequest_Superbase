<link rel="stylesheet" href="/css/modern-table.css">

<div class="content-header">
    <div>
        <h1 class="page-title">Quản lý Workflow</h1>
        <p class="page-subtitle">Quản lý quy trình xử lý yêu cầu</p>
    </div>
    <div class="content-actions">
        <button type="button" class="btn btn-primary" onclick="window.location.href='/workflows/builder'">
            <i class="fas fa-plus me-2"></i>Tạo workflow mới
        </button>
    </div>
</div>

{{#if success}}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle me-2"></i>{{success}}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{{/if}}

{{#if error}}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{error}}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{{/if}}

<!-- Modern Table Container -->
<div class="modern-table-container">
    <!-- Table Header -->
    <div class="table-header-section">
        <div class="table-title-wrapper">
            <div>
                <h2 class="table-title">
                    <i class="fas fa-project-diagram" style="color: var(--table-primary);"></i>
                    Danh sách Workflow
                </h2>
                <p class="table-subtitle">{{workflows.length}} quy trình trong hệ thống</p>
            </div>
        </div>
        <div class="table-actions">
            <button class="btn-modern btn-modern-secondary" onclick="window.location.href='/workflows/templates'">
                <i class="fas fa-layer-group"></i>
                Templates
            </button>
            <button class="btn-modern btn-modern-primary" onclick="window.location.href='/workflows/builder'">
                <i class="fas fa-plus"></i>
                Tạo workflow
            </button>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="table-filter-bar">
        <div class="filter-search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="tableSearch" name="search" value="{{search}}" 
                   placeholder="Tìm theo tên workflow, mô tả...">
        </div>

        <select class="filter-select" id="categoryFilter" name="category">
            <option value="">Tất cả danh mục</option>
            {{#each categories}}
            <option value="{{CategoryID}}" {{#ifEquals CategoryID ../selectedCategory}}selected{{/ifEquals}}>
                {{Name}}
            </option>
            {{/each}}
        </select>

        <select class="filter-select" id="statusFilter" name="status">
            <option value="">Tất cả trạng thái</option>
            <option value="active" {{#ifEquals status 'active'}}selected{{/ifEquals}}>Đang hoạt động</option>
            <option value="inactive" {{#ifEquals status 'inactive'}}selected{{/ifEquals}}>Không hoạt động</option>
            <option value="draft" {{#ifEquals status 'draft'}}selected{{/ifEquals}}>Bản nháp</option>
        </select>

        <button class="filter-btn" onclick="applyFilters()">
            <i class="fas fa-filter"></i>
            Lọc
        </button>

        <button class="filter-btn" onclick="clearFilters()">
            <i class="fas fa-times"></i>
            Xóa bộ lọc
        </button>
    </div>

    <!-- Table -->
    {{#if workflows.length}}
    <div class="table-responsive">
        <table class="modern-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="table-checkbox" id="selectAll">
                    </th>
                    <th style="width: 80px;">ID</th>
                    <th>Tên Workflow</th>
                    <th style="width: 150px;">Danh mục</th>
                    <th class="text-center" style="width: 120px;">Số bước</th>
                    <th class="text-center" style="width: 130px;">Trạng thái</th>
                    <th style="width: 140px;">Người tạo</th>
                    <th style="width: 140px;">Ngày tạo</th>
                    <th class="text-center" style="width: 180px;">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {{#each workflows}}
                <tr>
                    <td>
                        <input type="checkbox" class="table-checkbox" value="{{WorkflowID}}">
                    </td>
                    <td>
                        <span class="table-cell-id">#{{WorkflowID}}</span>
                    </td>
                    <td>
                        <div style="max-width: 400px;">
                            <div class="table-cell-name">
                                <i class="fas fa-sitemap" style="color: var(--table-primary); margin-right: 6px;"></i>
                                {{Name}}
                            </div>
                            {{#if Description}}
                            <div class="table-cell-secondary" style="margin-top: 4px;">
                                {{substring Description 0 80}}{{#if (gt Description.length 80)}}...{{/if}}
                            </div>
                            {{/if}}
                        </div>
                    </td>
                    <td>
                        {{#if CategoryName}}
                        <span class="table-status-badge status-info">
                            <i class="fas fa-folder"></i>
                            {{CategoryName}}
                        </span>
                        {{else}}
                        <span class="table-cell-secondary">Chưa phân loại</span>
                        {{/if}}
                    </td>
                    <td class="text-center">
                        <span class="table-status-badge status-info">
                            <i class="fas fa-list-ol"></i>
                            {{StepCount}} bước
                        </span>
                    </td>
                    <td class="text-center">
                        {{#ifEquals Status "active"}}
                        <span class="table-status-badge status-success">
                            <i class="fas fa-check-circle"></i>
                            Hoạt động
                        </span>
                        {{else}}{{#ifEquals Status "draft"}}
                        <span class="table-status-badge status-warning">
                            <i class="fas fa-edit"></i>
                            Bản nháp
                        </span>
                        {{else}}
                        <span class="table-status-badge status-danger">
                            <i class="fas fa-ban"></i>
                            Ngưng hoạt động
                        </span>
                        {{/ifEquals}}{{/ifEquals}}
                    </td>
                    <td>
                        <div class="table-cell-icon">
                            <div style="width: 32px; height: 32px; background: var(--table-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                                {{substring CreatedBy 0 1}}
                            </div>
                            <span class="table-cell-secondary">{{CreatedBy}}</span>
                        </div>
                    </td>
                    <td>
                        <span class="table-cell-secondary">{{formatDate CreatedAt}}</span>
                    </td>
                    <td>
                        <div class="table-actions-cell">
                            <button class="table-action-btn action-view" title="Xem chi tiết"
                                    onclick="viewWorkflow('{{WorkflowID}}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="table-action-btn action-edit" title="Chỉnh sửa"
                                    onclick="editWorkflow('{{WorkflowID}}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="table-action-btn action-copy" title="Sao chép"
                                    style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white;"
                                    onclick="duplicateWorkflow('{{WorkflowID}}')">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="table-action-btn action-delete" title="Xóa"
                                    onclick="deleteWorkflow('{{WorkflowID}}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {{#if pagination}}
    <div class="table-pagination">
        <div class="pagination-info">
            <span>{{workflows.length}} workflow</span>
            <i class="fas fa-sync-alt" onclick="location.reload()" 
               style="margin-left: 12px; cursor: pointer; color: var(--table-text-secondary);" 
               title="Làm mới"></i>
        </div>
        <div class="pagination-controls">
            <button class="pagination-btn" {{#if pagination.isFirst}}disabled{{/if}}
                    onclick="goToPage({{pagination.prevPage}})">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            {{#each pagination.pages}}
            <button class="pagination-btn {{#if active}}active{{/if}}"
                    onclick="goToPage({{page}})">
                {{page}}
            </button>
            {{/each}}
            
            <button class="pagination-btn" {{#if pagination.isLast}}disabled{{/if}}
                    onclick="goToPage({{pagination.nextPage}})">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    {{/if}}
    {{else}}
    <div class="table-empty-state">
        <div class="table-empty-icon">
            <i class="fas fa-project-diagram"></i>
        </div>
        <div class="table-empty-text">Không tìm thấy workflow</div>
        <div class="table-empty-subtext">
            {{#if search}}
            Không có workflow nào phù hợp với từ khóa "{{search}}"
            {{else}}
            Chưa có workflow nào trong hệ thống. Hãy tạo workflow đầu tiên.
            {{/if}}
        </div>
        <button class="btn-modern btn-modern-primary" style="margin-top: 20px;"
                onclick="window.location.href='/workflows/builder'">
            <i class="fas fa-plus"></i>
            Tạo workflow mới
        </button>
    </div>
    {{/if}}
</div>

<script>
// Filter functions
function getCurrentFilters() {
    const params = new URLSearchParams();
    const search = document.getElementById('tableSearch')?.value;
    const category = document.getElementById('categoryFilter')?.value;
    const status = document.getElementById('statusFilter')?.value;
    
    if (search) params.set('search', search);
    if (category) params.set('category', category);
    if (status) params.set('status', status);
    
    return params;
}

function applyFilters() {
    const params = getCurrentFilters();
    params.set('page', 1);
    window.location.search = params.toString();
}

function clearFilters() {
    window.location.href = '/workflows';
}

// Search on Enter
document.getElementById('tableSearch')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') applyFilters();
});

// Auto-submit on filter change
document.getElementById('categoryFilter')?.addEventListener('change', applyFilters);
document.getElementById('statusFilter')?.addEventListener('change', applyFilters);

// Select all checkbox
document.getElementById('selectAll')?.addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.modern-table tbody .table-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// Pagination
function goToPage(page) {
    const params = getCurrentFilters();
    params.set('page', page);
    window.location.search = params.toString();
}

// Workflow actions
function viewWorkflow(id) {
    window.location.href = `/workflows/${id}`;
}

function editWorkflow(id) {
    window.location.href = `/workflows/builder?id=${id}`;
}

function duplicateWorkflow(id) {
    if (confirm('Bạn có muốn tạo bản sao của workflow này?')) {
        fetch(`/workflows/${id}/duplicate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('Đã tạo bản sao workflow thành công!');
                location.reload();
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert('Có lỗi xảy ra!');
        });
    }
}

function deleteWorkflow(id) {
    if (confirm('Bạn có chắc chắn muốn xóa workflow này? Hành động này không thể hoàn tác.')) {
        fetch(`/workflows/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert('Có lỗi xảy ra!');
        });
    }
}
</script>
