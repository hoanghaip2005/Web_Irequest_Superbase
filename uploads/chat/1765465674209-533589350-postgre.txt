create extension if not exists pgcrypto;

do $$
begin
  if not exists (select 1 from pg_roles where rolname = 'teammate_editor') then
    create role teammate_editor login password '520huainy';
  end if;
end$$;

grant usage on schema public to teammate_editor;

do $$
begin
  if not exists (select 1 from pg_type where typname = 'gender') then
    create type gender as enum ('male','female','other');
  end if;
end$$;

do $$
begin
  if not exists (select 1 from pg_type where typname = 'request_status') then
    create type request_status as enum ('open','in_progress','done','rejected');
  end if;
end$$;

create table if not exists public.profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  full_name text not null,
  gender gender default 'male',
  date_of_birth date,
  email text unique,
  phone text,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.chat_groups (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  created_by uuid not null references public.profiles(id) on delete cascade,
  created_at timestamptz not null default now()
);

create table if not exists public.chat_group_members (
  id uuid primary key default gen_random_uuid(),
  group_id uuid not null references public.chat_groups(id) on delete cascade,
  user_id uuid not null references public.profiles(id) on delete cascade,
  role text not null default 'member',
  joined_at timestamptz not null default now(),
  unique (group_id, user_id)
);

create table if not exists public.messages (
  id uuid primary key default gen_random_uuid(),
  group_id uuid references public.chat_groups(id) on delete cascade,
  sender_id uuid not null references public.profiles(id) on delete cascade,
  receiver_id uuid references public.profiles(id) on delete cascade,
  body text not null,
  sent_at timestamptz not null default now(),
  constraint messages_sender_group_receiver_chk check (
    (group_id is not null and receiver_id is null)
    or
    (group_id is null and receiver_id is not null)
  )
);

create table if not exists public.requests (
  id uuid primary key default gen_random_uuid(),
  title text not null,
  content text,
  status request_status not null default 'open',
  user_id uuid not null references public.profiles(id) on delete cascade,
  assigned_user_id uuid references public.profiles(id) on delete set null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.request_comments (
  id uuid primary key default gen_random_uuid(),
  request_id uuid not null references public.requests(id) on delete cascade,
  user_id uuid not null references public.profiles(id) on delete cascade,
  content text not null,
  created_at timestamptz not null default now()
);

create table if not exists public.files (
  id uuid primary key default gen_random_uuid(),
  owner_id uuid not null references public.profiles(id) on delete cascade,
  path text not null,
  mime_type text,
  created_at timestamptz not null default now()
);

create index if not exists idx_requests_assignee on public.requests (assigned_user_id) where assigned_user_id is not null;

alter table public.profiles enable row level security;
alter table public.chat_groups enable row level security;
alter table public.chat_group_members enable row level security;
alter table public.messages enable row level security;
alter table public.requests enable row level security;
alter table public.request_comments enable row level security;
alter table public.files enable row level security;

do $$
begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='profiles' and policyname='profiles_select_own') then
    execute 'create policy "profiles_select_own" on public.profiles for select using (id = auth.uid())';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='profiles' and policyname='profiles_insert_self') then
    execute 'create policy "profiles_insert_self" on public.profiles for insert with check (id = auth.uid())';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='profiles' and policyname='profiles_update_own') then
    execute 'create policy "profiles_update_own" on public.profiles for update using (id = auth.uid()) with check (id = auth.uid())';
  end if;
end$$;

do $$
begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='chat_groups' and policyname='chat_groups_select_member_or_owner') then
    execute 'create policy "chat_groups_select_member_or_owner" on public.chat_groups for select using (created_by = auth.uid() or exists (select 1 from public.chat_group_members m where m.group_id = chat_groups.id and m.user_id = auth.uid()))';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='chat_groups' and policyname='chat_groups_insert_owner') then
    execute 'create policy "chat_groups_insert_owner" on public.chat_groups for insert with check (created_by = auth.uid())';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='chat_groups' and policyname='chat_groups_update_owner') then
    execute 'create policy "chat_groups_update_owner" on public.chat_groups for update using (created_by = auth.uid()) with check (created_by = auth.uid())';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='chat_groups' and policyname='chat_groups_delete_owner') then
    execute 'create policy "chat_groups_delete_owner" on public.chat_groups for delete using (created_by = auth.uid())';
  end if;
end$$;

do $$
begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='chat_group_members' and policyname='group_members_select_self_or_owner') then
    execute 'create policy "group_members_select_self_or_owner" on public.chat_group_members for select using (user_id = auth.uid() or exists (select 1 from public.chat_groups g where g.id = chat_group_members.group_id and g.created_by = auth.uid()))';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='chat_group_members' and policyname='group_members_insert_owner') then
    execute 'create policy "group_members_insert_owner" on public.chat_group_members for insert with check (exists (select 1 from public.chat_groups g where g.id = chat_group_members.group_id and g.created_by = auth.uid()))';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='chat_group_members' and policyname='group_members_delete_self') then
    execute 'create policy "group_members_delete_self" on public.chat_group_members for delete using (user_id = auth.uid())';
  end if;
end$$;

do $$
begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='messages' and policyname='messages_select_scoped') then
    execute 'create policy "messages_select_scoped" on public.messages for select using ((group_id is not null and exists (select 1 from public.chat_group_members m where m.group_id = messages.group_id and m.user_id = auth.uid())) or (group_id is null and (sender_id = auth.uid() or receiver_id = auth.uid())))';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='messages' and policyname='messages_insert_scoped') then
    execute 'create policy "messages_insert_scoped" on public.messages for insert with check ((group_id is not null and sender_id = auth.uid() and exists (select 1 from public.chat_group_members m where m.group_id = messages.group_id and m.user_id = auth.uid())) or (group_id is null and sender_id = auth.uid()))';
  end if;
end$$;

do $$
begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='requests' and policyname='requests_select_owner_or_assignee') then
    execute 'create policy "requests_select_owner_or_assignee" on public.requests for select using (user_id = auth.uid() or assigned_user_id = auth.uid())';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='requests' and policyname='requests_insert_owner') then
    execute 'create policy "requests_insert_owner" on public.requests for insert with check (user_id = auth.uid())';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='requests' and policyname='requests_update_owner_or_assignee') then
    execute 'create policy "requests_update_owner_or_assignee" on public.requests for update using (user_id = auth.uid() or assigned_user_id = auth.uid()) with check (user_id = auth.uid() or assigned_user_id = auth.uid())';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='requests' and policyname='requests_delete_owner') then
    execute 'create policy "requests_delete_owner" on public.requests for delete using (user_id = auth.uid())';
  end if;
end$$;

do $$
begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='request_comments' and policyname='request_comments_select_scoped') then
    execute 'create policy "request_comments_select_scoped" on public.request_comments for select using (exists (select 1 from public.requests r where r.id = request_comments.request_id and (r.user_id = auth.uid() or r.assigned_user_id = auth.uid())))';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='request_comments' and policyname='request_comments_insert_scoped') then
    execute 'create policy "request_comments_insert_scoped" on public.request_comments for insert with check (user_id = auth.uid() and exists (select 1 from public.requests r where r.id = request_comments.request_id and (r.user_id = auth.uid() or r.assigned_user_id = auth.uid())))';
  end if;
end$$;

do $$
begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='files' and policyname='files_select_owner') then
    execute 'create policy "files_select_owner" on public.files for select using (owner_id = auth.uid())';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='files' and policyname='files_insert_owner') then
    execute 'create policy "files_insert_owner" on public.files for insert with check (owner_id = auth.uid())';
  end if;
end$$;

grant select, insert, update, delete on all tables in schema public to teammate_editor;
grant usage, select, update on all sequences in schema public to teammate_editor;

do $$
begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='profiles' and policyname='profiles_select_editor_all') then
    execute 'create policy "profiles_select_editor_all" on public.profiles for select to teammate_editor using (true)';
  end if;
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='requests' and policyname='requests_editor_all') then
    execute 'create policy "requests_editor_all" on public.requests for all to teammate_editor using (true) with check (true)';
  end if;
end$$;
